#!c:/perl/bin/perl.exe

# Copyright Online-Store.co.uk 2008

# User Defined

# Folder for temporary files

local our $temp_dir = '';

local our $doc_dir = '';

local our $UKpartner='PayPal';


#local our $scriptMODE = "DEBUG"; 

local our $scriptMODE = "";

local our $URL="";

local our $SBAPISubject = "";
local our $APISubject = "";


######## Do not edit below this line ############################################

# currency_code ?


# Copyright Online-Store.co.uk 2008

local our %q = (); # html encoded data
local our %u = (); # url encoded data
local our %n = (); # no encoding

my $SandboxURL = "https://api-3t.sandbox.paypal.com/nvp";
my $LiveURL = "https://api-3t.paypal.com/nvp";


local our $e_mail_address = '';
local our $merchant_email = '';

if($ENV{'SERVER_PORT'} eq '80')
   {
   $ReturnURL = 'http://' . $ENV{'SERVER_NAME'} . $ENV{'REQUEST_URI'};
   }
else
   {
   $ReturnURL = 'https://' . $ENV{'SERVER_NAME'} . $ENV{'REQUEST_URI'};	   
   }	   

	   
local our $sendmail = '/usr/sbin/sendmail';

local our %order;

local our $TRXTYPE ='S';

local our $sales_tax="Sales Tax";

if($currency_code eq "EUR" || $currency_code eq "GBP")
   {
   $sales_tax = "VAT";		
   }

if($PAYMENTACTION eq 'Sale')
   {
   $TRXTYPE ='S';	
   }
   
if($PAYMENTACTION eq 'Authorization')
   {
   $TRXTYPE ='A';
   }

local our $pfurl = 'pilot-payflowpro.paypal.com';

if($UKtest eq 'Live')
   {
   $pfurl = 'payflowpro.paypal.com';	
   }
        
        
# Fetch the data for this request.
my $data = "";

    if ( $ENV{'REQUEST_METHOD'} eq 'POST' )
       {
       # Read it from standard input.
       my ($len) = $ENV{'CONTENT_LENGTH'};
       if ( read (STDIN, $data, $len) != $len )
         {
         &end_cgi("Error reading 'POST' data");
         }
       }
    else
       {
       # Fetch from environment variable.
       $data = $ENV{'QUERY_STRING'};
       }


    # The data is encoded as name1=val1&name2=val2&etc.
    # First split on name/value pairs.
    foreach my $q ( split ('&', $data) ) {
        # Then split name and value.
        my ($name, $val) = split ('=', $q);

        # URL decode and put in resultant hash array.
        
         if ( defined $u{$name} ) {
           # Multiple values. Append using \0 separator.
            $u{$name} .= "\0" . $val;
        }
        else {
            # Store it.
            $u{$name} = $val;
        }
        
       
        
        $name = &url_decode ($name);
        $val  = &url_decode ($val);
        
        $n{$name} = $val;
        
        $name=&convert2($name);
        $val=&convert2($val);
               
        if ( defined $q{$name} ) {
           # Multiple values. Append using \0 separator.
            $q{$name} .= "\0" . $val;
        }
        else {
            # Store it.
            $q{$name} = $val;
        }
      }


########### Read Data File ###########      

if($doc_dir eq "")

   {


 # if ($ENV{'DOCUMENT_ROOT'} ne undef)
 #     {
 #     $doc_dir = $ENV{'DOCUMENT_ROOT'};
 #     $doc_dir = $doc_dir . '/';
 #     }
 #  else
 #     {
	  #if($ENV{'PATH_TRANSLATED'} ne undef)
	 
      if($ENV{'SCRIPT_FILENAME'} ne undef)
         {
         my $doc1 = $ENV{'SCRIPT_FILENAME'};
         $doc1 =~ s#\\#/#g;
         my $pos1 = rindex($doc1,'/');
         
         $doc_dir = substr($doc1,0,$pos1);
         
        # $doc1 = substr($doc1,0,$pos1);
        # $pos1 = rindex($doc1,'/');
        # $doc_dir = substr($doc1,0,$pos1);

         $doc_dir = $doc_dir . '/';
         }
  #    }
   }   



my $override = "No";
      
if($override eq "Yes")
{

my $data_file_contents ="";

my $file= $doc_dir . "data_file.ssc";

   ( open (FILE_LIST,$file) ) || (&end_cgi ("Cannot read $file: $!"));


   while (<FILE_LIST>)
      {
      $data_file_contents = $data_file_contents . $_;

      }
 
    close(FILE_LIST);

   local our %r=();

    
######## Decode Data File ##############


    # The data is encoded as name1=val1&name2=val2&etc.
    # First split on name/value pairs.
    foreach my $r ( split ('\|', $data_file_contents) ) {
        # Then split name and value.
        my ($name, $val) = split ('=', $r);
       # URL decode and put in resultant hash array.
        $name = &url_decode ($name);
        
        $r{$name} = &url_decode ($val); 
    }  


#my $rootURL = 'http://default/store/';

#my $pro_country = 'US';


#$pay_pal=$r{'paypal'};$business=$r{'business_name'};$paypal_no_shipping=$r{'paypal_no_shipping'};$paypal_no_note=$r{'paypal_no_note'};$paypal_cn=$r{'paypal_cn'};
   
#$paypal_url=$r{'paypal_url'};$paypal_image_url=$r{'paypal_image_url'};$paypal_cancel_payment=$r{'paypal_cancel_payment'};$paypal_return=$r{'paypal_return'};
   
#$tax_rates=$r{'sales_tax'};$postbox=$r{'shipping'};$currency_code=$r{'currency_code'};$weight_text=$r{'weight_text'};

$currency_code=$r{'currency_code'};

$merchant_email=$r{'merchant_email'};
   
$paypal_pro=$r{'paypal_pro'};$paypal_pro_uk=$r{'paypal_pro_uk'};
   
$APIusername=$r{'APIusername'};$APIusername=$r{'APIpassword'};$APIsignature=$r{'APIsignature'};$PayPalAccount=$r{'PayPalAccount'};$SBAPIusername=$r{'SBAPIusername'};$SBAPIpassword=$r{'SBAPIpassword'};$SBAPIsignature=$r{'SBAPIsignature'};
 
$PAYMENTACTION=$r{'PAYMENTACTION'};$CancelURL=$r{'CancelURL'};#$HTTPS_PROXY=$r{'HTTPS_PROXY'};
   
$UKvendor=$r{'UKvendor'};$UKusername=$r{'UKusername'};$UKpassword=$r{'UKpassword'};$UKtest=$r{'UKtest'};

if($paypal_pro =~ /US/i)
   {
   #$paypal_express = 'No';
   $pro_country = 'US';
   $paypal_pro = 'Yes';
   $paypal_pro_uk = 'No';
   }
   
if($paypal_pro =~ /UK/i)
   {
   #$paypal_express = 'No';
   $pro_country = 'UK';
   $paypal_pro = 'No';
   $paypal_pro_uk = 'Yes';
   }
   
if($paypal_pro =~ /Express/i)
   {
   #$paypal_express = 'Yes';
   $pro_country = 'US';
   $paypal_pro = 'Yes';
   $paypal_pro_uk = 'No';
   }


$currency_symbol='';

if($currency_code eq "GBP")
   {
   $currency_symbol='&#163;'; 
   }

if($currency_code eq "USD")
   {
   $currency_symbol='$';
   }   
   
   
if($currency_code eq "JPY")
   {
   $currency_symbol='&yen;';
   }

if($currency_code eq "EUR")
   {
   $currency_symbol='&euro;';
   }

if($currency_code eq "CAD")
   {
   $currency_symbol='$';
   }

if($currency_code eq "AUD")
   {
   $currency_symbol='$';
   }

       
if($paypal_pro_uk eq 'Yes')
   {
   $pro_country = 'UK';		
   } 
        
if($paypal_pro eq 'Yes')
   {
   $pro_country = 'US';		
   }
   
}
         
##### End of Read Data File #####      
      
      
      
my %cookie_hash;

if(($q{'s'} eq 't') || ($q{'s'} eq 'c'))
   {
      
   if ($ENV{'HTTP_COOKIE'} ne undef)
      {  
	  my @cookies = split (/; /, $ENV{'HTTP_COOKIE'});
	  foreach my $cookie (@cookies)
	     {
  	  	  
	     my ($name, $value) = split (/=/, $cookie);
	     $name = &uriunescape($name);	
	     #$value = &uriunescape($value);	
  
	     $cookie_hash{$name} = $value;
	   
	     } 

	  my $m=0;
	     	  
	  while($cookie_hash{"ssc$m"} ne undef)
	     {
		 # parse response into name/value pairs
         my @pairs = split(/&/, $cookie_hash{"ssc$m"});
         
         foreach my $pair (@pairs)
            {
            my ($name, $value) = split(/_/, $pair);
            $name = &uriunescape($name);	
	        $value = &uriunescape($value);
            $order{$name} = $value;
            } 
	     $m++;
         }   		     
	  }     
   }

    
# s==t &GetExpressCheckoutDetails s==c &DoExpressCheckoutPayment
# Read stored file data and place in order array.

#if(($q{'s'} eq 't') || ($q{'s'} eq 'c'))
#   {

#   my $file = $temp_dir . $q{'token'} . '.tmp';

#   (open (FILE_LIST, $file)) || (&end_cgi ("Cannot read $file: $!"));
   
#   while (<FILE_LIST>)
#      {

#	  my ($first,$last) = split(/\|ssc3/,$_);
      
#      chop($last); 
#      chop($last); 
      
#      if(!($first =~ /submit/i))
#         {	   
#         $order{$first}=$last;	
#         }

#      }
      
#   close(FILE_LIST);      
      
#   }  

      
my $back_button ="<script language='JavaScript'><!--\r\n" .
   "document.write('<br><br><input type=\"button\" value=\"Return\" name=\"b1\" onClick=\"history.go(-1)\">&nbsp;&nbsp;')" .           
   "\r\n--></script>";
   
my $begin ="<HTML>
<HEAD>
<TITLE>Shopping Cart</TITLE>
</HEAD>
<BODY topmargin='0' leftmargin='0' onload='javascript:this.focus();'>";
   
my $end =
"<!--version 3.95s 08 08 2008--></BODY>
</HTML>";   
   
      

if($q{'s'} eq 'o' || $q{'APIcall'} eq 'SetExpressCheckout')
   {   

   if($ENV{'HTTP_COOKIE'} eq undef)
      {   
      print "Content-Type: text/html\n\n";   	   
      print $begin;
      print "<br><br>Error. This payment method requires a browser with cookies enabled";
      print $back_button;
      print $end;
      exit;
      }   
     
     
   my %ssc;
   my $n=0;
   
   while(my ($first,$last) = each(%q))
      {
      my $temp =  $ssc{$n} . &uriescape($first) . '_' . &uriescape($last) . '&';		  
	  
      if(length($temp)<4000)
         {  
         $ssc{$n} = $temp; 
         }
      else
         {
	     $n++;
	     $ssc{$n} = &uriescape($first) . '_' . &uriescape($last) . '&';   
         } 
      }
      
   my $m=0;      
   while($ssc{$m} ne "")
      {   
      print "Set-Cookie: ssc$m=" . $ssc{$m} . ";\n";
      $m++;
      }
      
   print "Set-Cookie: ssc$m=;\n";      
   }   
      

print "Content-Type: text/html; charset=ISO-8859-1\n\n";

#&payflow_direct();


#exit;
#print $order{'ITEMAMT'};

#$q{"ReturnURL"} = $ReturnURL . '?s=t';

#$q{"CancelURL"} = $CancelURL; 

local our $APIcall = $q{'APIcall'};

#$q{'paypal_url'};

local our $paypal_url ="";

if($PayPalAccount eq 'Sandbox' || $UKtest eq 'Test')
   {
   $paypal_url = "sandbox.paypal.com"	
   }
else
   {
   $paypal_url = "paypal.com";	
   }


#if($pro_country ne 'UK')
#{

if ($PayPalAccount eq "Sandbox")
   {
   $APIusername  = $SBAPIusername;
   $APIpassword  = $SBAPIpassword;
   $APIsignature = $SBAPIsignature;
   $URL =  $SandboxURL;
   }
else
   {
   $URL =  $LiveURL;   	   
   }

#}   
   
   
   
   
# ===== SET CREDENTIAL STRING ======

local our   $AuthString = "USER=".$APIusername."&PWD=".$APIpassword."&SIGNATURE=".$APIsignature."&VERSION=50.0";

   if($APISubject ne "")
      {	       
      #$AuthString .= uriescape("&SUBJECT=".$APISubject);
      $AuthString .= "&SUBJECT=".$APISubject;
      }

# =======BUILD API REQUEST STRING================

 #&direct_payment_us_nvp(); 

#print $q{'APIcall'};
 
   
if($q{'pro'} eq '2' && $paypal_pro eq "Yes")
   {
   &direct_payment_us_nvp();   	
   exit;
   } 
      
if($q{'pro'} eq '2' && $paypal_pro_uk eq "Yes")
   {
   &payflow_direct();   	
   exit;
   }   
   
      
if($q{'s'} eq 'o' || $q{'APIcall'} eq 'SetExpressCheckout' && $pro_country eq "US")
   {
   &SetExpressCheckout();   	
   exit;
   }
   
if($q{'s'} eq 'o' || $q{'APIcall'} eq 'SetExpressCheckout' && $pro_country eq "UK")
   {
   &SetExpressCheckoutUK();   	
   exit;
   }  

if($q{'s'} eq 't' && $pro_country eq "US")
   {
   &GetExpressCheckoutDetails();   	
   exit;
   }     
   
if($q{'s'} eq 't' && $pro_country eq "UK")
   {
   &GetExpressCheckoutDetailsUK();   	
   exit;
   } 
   
   
if($q{'s'} eq 'c' && $pro_country eq "US")
   {
   &DoExpressCheckoutPayment();   	
   exit;
   }  
   
if($q{'s'} eq 'c' && $pro_country eq "UK")
   {
   &DoExpressCheckoutPaymentUK();   	
   exit;
   }    
    

if($q{'APIcall'} eq 'PrintDirectPaymentForm')
   {
   &order_form();   	
   exit;
   }       
     
   
##### Sub routines #############

sub tformat
   {
   my ($value) = @_;
     	   
   if($currency_code ne 'JPY')
      {  	   
      $value = $currency_symbol . sprintf("%.2f",$value);   
      }
   else
      {
      $value = $currency_symbol . sprintf("%.0f",$value);	   
      }
         
   return $value;   
   }

   
sub sformat
   {
   my ($value) = @_;
     	   
   if($order{'currency_code'} ne 'JPY')
      {  	   
      $value = sprintf("%.2f",$value);   
      }
   else
      {
      $value = sprintf("%.0f",$value);	   
      }
         
   return $value;   
   }
   
   

sub direct_payment_us_nvp
   {
      

my $ipaddress = $ENV{"REMOTE_ADDR"};


my $APIrequest="";	   

my $item_total = 0;

#if($q{'tax_1'} eq undef)
#  {
#  $q{'tax_1'} = "";	
#  }


  
if($u{'shipping_1'} eq undef)
  {
  $u{'shipping_1'} = "";	  
  }	  


  
my $order='';
  
for(my $n=1;$u{"item_name_$n"} ne undef;$n++)
   {
	   
    $item_total = $item_total + ($u{"quantity_$n"} * $u{"amount_$n"}); 
	   
   #if($n>1)
   #   { 	       
   #   if($u{"tax_1"} eq "")
   #      {
   #      $u{"tax_$n"} ="";
   #      }   
   #   else
   #      {
   #      $u{"tax_$n"} ="0.00";
   #      } 
   #   } 
  	
   my $item_number = $u{"item_number_$n"};   
          
   if($u{"pro_on0_$n"} ne undef)
      {
      $item_number = $item_number . " - " . $u{"pro_on0_$n"} . ":" . $u{"pro_os0_$n"};
      }
   
   if($u{"pro_on1_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $u{"pro_on1_$n"} . ":" . $u{"pro_os1_$n"};
      }
  
   if($u{"pro_on2_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $u{"pro_on2_$n"} . ":" . $u{"pro_os2_$n"};
      }
      
      
    $u{"item_number_$n"} = $item_number;  
   
    my $i=$n-1;
         
    $order .= 
    '&L_NAME' . "$i=" . $u{"item_name_$n"} .
    '&L_NUMBER' . "$i=" . $u{"item_number_$n"} .
    '&L_QTY' . "$i=" . $u{"quantity_$n"} .  
    '&L_AMT' . "$i=" . $u{"amount_$n"};
    
     if($u{"L_TAXAMT$i"} ne undef)
        {
        $order .= '&L_TAXAMT' . "$i" . "=" . $u{"L_TAXAMT$i"};
        }


   }
	  
if($u{'delivery_address'} eq "ON")
   {
   $u{'del_name'} = $u{'cc_first_name'} . "+" . $u{'cc_last_name'};
   $u{'del_addr1'} = $u{'cc_addr1'};	   
   $u{'del_addr2'} = $u{'cc_addr2'};
   $u{'del_city'} = $u{'cc_city'};
   $u{'del_state'} = $u{'cc_state'};
   $u{'del_country'} = $u{'cc_country'};
   $u{'del_postalcode'} = $u{'cc_postcode'};
   }
   
   
$APIrequest = '&METHOD=DoDirectPayment' .

'&PAYMENTACTION=' . $PAYMENTACTION .
'&IPADDRESS=' . $ipaddress .
'&CREDITCARDTYPE=' . $u{'cc_type'} .
'&ACCT=' . $u{'cc_number'} .
'&EXPDATE=' . $u{'cc_month'} . $u{'cc_year'} .
'&CVV2=' . $u{'cc_security_code'} .
'&AMT=' . $u{'OrderTotal'} .
'&FIRSTNAME=' .  $u{'cc_first_name'} .
'&LASTNAME=' . $u{'cc_last_name'} .
'&STREET=' .$u{'cc_addr1'} .
'&CITY=' . $u{'cc_city'} .
'&STATE=' . $u{'cc_state'} .
'&ZIP=' . $u{'cc_postcode'} .


'&COUNTRYCODE=' . $u{'cc_country'} . 

'&CURRENCYCODE=' . $currency_code .

'&ITEMAMT=' . $u{'ITEMAMT'} .

'&SHIPPINGAMT=' . $u{'shipping_1'} .

'&TAXAMT=' .  $u{'tax_cart'} .

# subtotals

#"&DESC=NVP_perl_DirectPaymentExample" .

$order .

'&SHIPTONAME=' . $u{'del_name'} .
'&SHIPTOSTREET=' . $u{'del_addr1'} .
'&SHIPTOSTREET2=' . $u{'del_addr2'} .
'&SHIPTOSTATE=' .  $u{'del_state'} .
'&SHIPTOCITY=' .  $u{'del_city'} .
'&SHIPTOZIP=' . $u{'del_postalcode'} .
'&SHIPTOCOUNTRYCODE=' . $u{'del_country'} .

'&PHONENUM=' . $u{'cc_telephone'} .


'&EMAIL=' . $u{'cc_email'};


#if($q{"pro_shipping"} eq undef)
#   {
#   $u{"pro_shipping"} ="";
#   }
   

# This line prints the ENTIRE request string - for DEBUG
if ($scriptMODE eq "DEBUG")
   {
   print "content-type: text/html\n\n";
   print "The full request string is for direct payment nvp: ".$AuthString.$APIrequest."<br><br><hr><br>";
   }


# post to PayPal
use LWP::UserAgent;
my $ua = new LWP::UserAgent;
my $req = new HTTP::Request POST => $URL;


#$req->content_type('application/x-www-form-urlencoded');
$req->content($AuthString.$APIrequest);

my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 


# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG"){
print "Debug Details 1: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";
}

#TIMESTAMP=2008%2d01%2d23T23%3a10%3a17Z
#CORRELATIONID=c946fd0036f27
#ACK=Success
#VERSION=2%2e300000
#BUILD=1%2e0006
#AVSCODE=X
#CVV2MATCH=M
#TRANSACTIONID=79C97557A64787619
#AMT=10%2e00
#CURRENCYCODE=USD


if($v{'ACK'} eq "Success")
{



my $out="";

#(open (FILE_LIST,($doc_dir . "success.html")) ) || (&end_cgi ("Cannot read $doc_dir success.html: $!"));

#while (<FILE_LIST>)
#   {
#   $out = $out . $_;
#   }

#close(FILE_LIST);
   
$out = &direct_success_form();
   
my $edit_button =
"<form method='POST' action='https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$q{'Token'}'>
<input type='submit' value='Edit' name='B1'>
</form>";

#$q{'PaymentAction'}="Sale";
#$q{'$currency'} = "USD";
#$q{'cc_type'} = "Visa";
#$q{'cc_number'} = "4444333322221111";
#$q{'cc_month'} = "01";
#$q{'cc_year'} = "2006";
#$q{'cc_email'} = "test\@test.com";
#$q{'cc_first_name'} = "John";
#$q{'cc_second_name'} = "Smith";
#$q{'cc_addr1'} = "test address 1";
#$q{'cc_addr2'} = "test address 2";
#$q{'cc_city'} = "test city";
#$q{'cc_state'} = "NY";
#$q{'cc_country'} = "US";
#$q{'cc_postalcode'} = "23444";
#$q{'cc_security_code'} = "234";


my $table = &make_table(); # directpayment

#$out =~ s/EditBilling/$edit_button/;     
#$out =~ s/EditShipping/$edit_button/; 

$out =~ s/BillingCustomerName/$q{"cc_first_name"} $q{'cc_last_name'}/;     
$out =~ s/BillingStreet1/$q{"cc_addr1"}/;  
$out =~ s/BillingStreet2/$q{"cc_addr2"}/;  
$out =~ s/BillingCityName/$q{"cc_city"}/;  
$out =~ s/BillingStateorProvince/$q{"cc_state"}/;  
$out =~ s/BillingPostalCode/$q{"cc_postcode"}/;  
$out =~ s/BillingCountryName/$q{"cc_country"}/;  
$out =~ s/PayPalName/$q{"cc_email"}/;

$out =~ s/ShippingCustomerName/$q{"del_name"}/;     
$out =~ s/ShippingStreet1/$q{"del_addr1"}/;  
$out =~ s/ShippingStreet2/$q{"del_addr2"}/;  
$out =~ s/ShippingCityName/$q{"del_city"}/;  
$out =~ s/ShippingStateorProvince/$q{"del_state"}/;  
$out =~ s/ShippingPostalCode/$q{"del_postalcode"}/;  
$out =~ s/ShippingCountryName/$q{"del_country"}/;  

$out =~ s/PayPalTransactionID/$v{'TRANSACTIONID'}/;   
$out =~ s/<!--table-->/$table/;   
    
print $out;

      


}
else
{
	
   if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

   my $s=0;
   while($v{"L_LONGMESSAGE$s"} ne undef)
      {
      print $v{"L_LONGMESSAGE$s"} . " <br><br>\r\n";
      $s++;	
      }
      
   print "<script language='JavaScript'><!--\r\n" .
   "document.write('<br><br><input type=\"button\" value=\"Return\" name=\"b1\" onClick=\"history.go(-1)\">&nbsp;&nbsp;')" .           
   "\r\n--></script>";   

   exit;

}


exit;
}


sub payflow_direct
   {
      

my $ipaddress = $ENV{"REMOTE_ADDR"};


my $APIrequest="";	   

my $item_total = 0;


  
if($q{'shipping_1'} eq undef)
  {
  $q{'shipping_1'} = "";	  
  }	  


  
my $order='';
  

my %d;


for(my $n=1;$q{"item_name_$n"} ne undef;$n++)
   {
	   
    $item_total = $item_total + ($u{"quantity_$n"} * $u{"amount_$n"});
	   
  	
   my $item_number = $q{"item_number_$n"};   
          
   if($q{"pro_on0_$n"} ne undef)
      {
      $item_number = $item_number . " - " . $q{"pro_on0_$n"} . ":" . $q{"pro_os0_$n"};
      }
   
   if($q{"pro_on1_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $q{"pro_on1_$n"} . ":" . $q{"pro_os1_$n"};
      }
  
   if($q{"pro_on2_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $q{"pro_on2_$n"} . ":" . $q{"pro_os2_$n"};
      }
      
    $q{"item_number_$n"} = $item_number;    
   
    my $i=$n-1;
         
    $order .= 
   #$d{"L_DESC$i"} = "12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890";
   $d{"L_DESC$i"} =  $q{"item_number_$n"} . ' - ' . $q{"item_name_$n"};
   #$d{"L_DESC$i"} = substr($d{"L_DESC$i"},0,127);
   # $q{"item_number_$n"} .
    $d{"L_QTY$i"} = $q{"quantity_$n"};  
    $d{"L_AMT$i"} = $q{"amount_$n"};
    
     if($q{"L_TAXAMT$i"} ne undef)
        {
        $d{"L_TAXAMT$i"} =  $q{"L_TAXAMT$i"};
        }

   }
	  

   
if($q{'delivery_address'} eq "ON")
   {
   $q{'del_name'} = $q{'cc_first_name'} . " " . $q{'cc_last_name'} ;   
   $q{'del_addr1'} = $q{'cc_addr1'};	   
   $q{'del_addr2'} = $q{'cc_addr2'};
   $q{'del_city'} = $q{'cc_city'};
   $q{'del_state'} = $q{'cc_city'};
   $q{'del_country'} = $q{'cc_country'};
   $q{'del_postalcode'} = $q{'cc_postcode'};
   }     



if ($scriptMODE eq "DEBUG")
   {
   print "content-type: text/html\n\n";
   print $d{"L_DESC0"} . '<br>';
   print $d{"L_QTY0"} . '<br>';
   print $d{"L_AMT0"} . '<br>';
    
   }
   
   
$d{'VENDOR'} = $UKvendor;
   
if($UKusername eq '')
   {
   $d{'USER'} = $UKvendor; 
   }
else
   {
   $d{'USER'} = $UKusername; #Additional Users	
   }


$d{'PARTNER'} = $UKpartner;


$d{'PWD'} = $UKpassword;

$d{'CLIENTIP'} = $ipaddress;

$d{'TRXTYPE'} = $TRXTYPE;
$d{'TENDER'} = 'C';	# credit card


#$d{'ACCT'} = '5555555555554444';
$d{'ACCT'} =  $q{'cc_number'};
$d{'EXPDATE'} =  $q{'cc_month'} . $q{'cc_year'};
$d{'CVV2 '} =  $q{'cc_security_code'};

$d{'FIRSTNAME'} =  $q{'cc_first_name'};
$d{'LASTNAME'} =  $q{'cc_last_name'};

$d{'STREET'} =  $q{'cc_addr1'};
$d{'CITY'} =  $q{'cc_city'};
$d{'STATE'} =  $q{'cc_state'};
$d{'ZIP'} =  $q{'cc_postcode'};
$d{'COUNTRY'} =  $q{'cc_country'};

#$u{'del_name'}
$d{'SHIPTOSTREET'} = $u{'del_addr1'};
#$u{'del_addr2'}
$d{'SHIPTOCITY'} =  $q{'del_city'};
$d{'SHIPTOSTATE'} =  $q{'del_state'};
$d{'SHIPTOZIP'} =  $q{'del_postalcode'};
$d{'SHIPTOCOUNTRY'} =  $q{'del_country'};

if(length($q{'short_desc'})<128)
   {
   $d{'ORDERDESC'} = $q{'short_desc'};		
   }
   else
   {
   $d{'ORDERDESC'} = "See Separate Email for Full Order Details";		   
   }

$d{'COMMENT1'} = substr($q{'short_desc'},0,128);
$d{'COMMENT2'} = substr($q{'short_desc'},128,255);

$d{'CUSTOM'} = substr($q{'short_desc'},0,255);




$d{'EMAIL'} = $q{'cc_email'};
$d{'PHONENUM'} = $q{'cc_telephone'};


$d{'CURRENCY'} = $currency_code;

$d{'AMT'} = $q{'OrderTotal'};

$d{'FRIEGHTAMT'} = $q{'shipping_1'};
$d{'ITEMAMT'} =  $q{'ITEMAMT'};
$d{'TAXAMT'} = $q{'tax_cart'};      # no tax charged, but specifying it lowers cost

$d{'INVNUM'} = $$;
#$d{'DESC'} = "Test invoice $$";


#$d{'COMMENT1'} = "Comment 1 $$";
#$d{'COMMENT2'} = "Comment 2 $$";

#$d{'CUSTCODE'} = "";


#$d{'PONUM'} = $$.'-'.$$;

use LWP::UserAgent;
my $ua = new LWP::UserAgent;
#my $req = new HTTP::Request POST => $URL;


my $req = new HTTP::Request POST => "https://$pfurl/transaction";
   $req->content_type('text/namevalue');
   $req->header('X-VPS-REQUEST-ID' => time,  # unique id
	     'X-VPS-CLIENT-TIMEOUT' => '45',
	     'X-VPS-VIT-CLIENT-CERTIFICATION-ID' => 'ssc3',
	     'X-VPS-VIT-INTEGRATION-PRODUCT' => 'Shop 3',
	     'X-VPS-VIT-INTEGRATION-VERSION' => '3.95',

#	     'X-VPS-VIT-OS-NAME' => $Config::Config{osname},
#	     'X-VPS-VIT-OS-VERSION' => $Config::Config{osvers},
	     'X-VPS-VIT-RUNTIME-VERSION' => $],

	     'Connection' => 'close',
	     'Host' => $pfurl,
	    );


while(my($first,$last) = each(%d))
   {
	   	   	    
   my $l = length($last);
   $req->add_content($first."[$l]=".$last.'&');
   
   if ($scriptMODE eq "DEBUG")
      {
	  print $first ."[$l]=" . $last . '&' .  "\r\n";	
      }
   }
   
   $req->add_content('VERBOSITY=MEDIUM');

   $req->content_length(length(${$req->content_ref}));
  
  
# $req->content_length(length(${$req->content_ref}));
#$AuthString = "USER=".$APIusername."&PWD=".$APIpassword."&SIGNATURE=".$APIsignature."&VERSION=50.0";
	    
	    
	    
my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 


# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG")
   {
   print "Debug Details 1: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";
   }


#RESULT=0&PNREF=V18A0D9D899C&RESPMSG=Approved&AUTHCODE=113PNI&AVSADDR=Y&AVSZIP=Y&HOSTCODE=A&PROCAVS=Y&IAVS=N


if($v{'RESULT'} eq "0")
{


my $out="";

#(open (FILE_LIST,($doc_dir . "success.html")) ) || (&end_cgi ("Cannot read $doc_dir success.html: $!"));

#while (<FILE_LIST>)
#   {
#   $out = $out . $_;
#   }

$out = &direct_success_form();   
   
   
my $edit_button =
"<form method='POST' action='https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$q{'Token'}'>
<input type='submit' value='Edit' name='B1'>
</form>";

my $table = &make_table(); # directpayment

#$out =~ s/EditBilling/$edit_button/;     
#$out =~ s/EditShipping/$edit_button/; 

$out =~ s/BillingCustomerName/$q{"cc_first_name"} $q{'cc_last_name'}/;     
$out =~ s/BillingStreet1/$q{"cc_addr1"}/;  
$out =~ s/BillingStreet2/$q{"cc_addr2"}/;  
$out =~ s/BillingCityName/$q{"cc_city"}/;  
$out =~ s/BillingStateorProvince/$q{"cc_state"}/;  
$out =~ s/BillingPostalCode/$q{"cc_postalcode"}/;  
$out =~ s/BillingCountryName/$q{"cc_country"}/;  
$out =~ s/PayPalName/$q{"cc_email"}/;

$out =~ s/ShippingCustomerName/$q{"del_name"}/;     
$out =~ s/ShippingStreet1/$q{"del_addr1"}/;  
$out =~ s/ShippingStreet2/$q{"del_addr2"}/;  
$out =~ s/ShippingCityName/$q{"del_city"}/;  
$out =~ s/ShippingStateorProvince/$q{"del_state"}/;  
$out =~ s/ShippingPostalCode/$q{"del_postalcode"}/;  
$out =~ s/ShippingCountryName/$q{"del_country"}/;  

$out =~ s/PayPalTransactionID/$v{'PNREF'}/;   
$out =~ s/<!--table-->/$table/;   
    
print $out;

 
close(FILE_LIST);

if($merchant_email ne '')
   {

   my $message = &make_email();	   
	   
   open(MAIL,"| " . $sendmail . " -t") || (&end_cgi ("Cannot read open SendMail "));
              
   print MAIL "From: " . $q{"cc_email"} . "\n";
   print MAIL "To: " . $merchant_email . "\n";

# Check for Message Subject
   print MAIL "Subject: Customer Orders \n\n";

   print MAIL "$message\n";
         
   close(MAIL);
   
  # print $message;
      
   open(MAIL,"| " . $sendmail . " -t") || (&end_cgi ("Cannot read open SendMail "));
              
   print MAIL "From: " . $merchant_email . "\n";
   print MAIL "To: " . $q{"cc_email"} . "\n";

# Check for Message Subject
   print MAIL "Subject: Details of your Order \n\n";

   print MAIL "$message\n";
         
   close(MAIL);
   
   #print $message;
   
   
   }


}
else
{
	
   if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

 
    print $v{"RESPMSG"} . " <br><br>\r\n";
    
   print "<script language='JavaScript'><!--\r\n" .
   "document.write('<br><br><input type=\"button\" value=\"Return\" name=\"b1\" onClick=\"history.go(-1)\">&nbsp;&nbsp;')" .           
   "\r\n--></script>";

    exit;

}

exit;
}

#####################################

sub make_email
{
my $out = '';


$out .= "BillingCustomerName: $q{'cc_first_name'} $q{'cc_last_name'}\r\n";     
$out .= "BillingStreet1: $q{'cc_addr1'}\r\n";  
$out .= "BillingStreet2: $q{'cc_addr2'}\r\n";  
$out .= "BillingCityName: $q{'cc_city'}\r\n";  
$out .= "BillingStateorProvince: $q{'cc_state'}\r\n";  
$out .= "BillingPostalCode: $q{'cc_postalcode'}\r\n";  
$out .= "BillingCountryName: $q{'cc_country'}\r\n";  
$out .= "PayPalName: $q{'cc_email'}\r\n";

$out .= "ShippingCustomerName: $q{'del_name'}\r\n";     
$out .= "ShippingStreet1: $q{'del_addr1'}\r\n";  
$out .= "ShippingStreet2: $q{'del_addr2'}\r\n";  
$out .= "ShippingCityName: $q{'del_city'}\r\n";  
$out .= "ShippingStateorProvince: $q{'del_state'}\r\n";  
$out .= "ShippingPostalCode: $q{'del_postalcode'}\r\n";  
$out .= "ShippingCountryName: $q{'del_country'}\r\n\r\n";  

#out .= "PayPalTransactionID: $v{'PNREF'}";  
	
 my  $n=1;
   
 my $table=""  ;
 
 
 my $item_total = 0;
   
   while($q{('quantity_' . $n)} ne undef)   
      {
     
      $table = $table . "$q{('item_name_' . $n)}\r\n"; 
      
      if($q{('pro_on0_' . $n)} ne undef)
         {
          $table = $table . "$q{'pro_on0_' . $n}:$q{'pro_os0_' . $n}\r\n";
         }
      
      if($q{('pro_on1_' . $n)} ne undef)
         {
         $table = $table . "$q{'pro_on1_' . $n}:$q{'pro_os1_' . $n}\r\n";
         }   
         
      if($q{('pro_on2_' . $n)} ne undef)
         {
         $table = $table . "$q{'pro_on2_' . $n}:$q{'pro_os2_' . $n}\r\n";
         }   
                
      
      if($q{('item_number_' . $n)} ne "")
         {
         $table = $table . "Item Number: $q{('item_number_' . $n)}\r\n";
         }    
               
         
          

      
      $table = $table . "Unit Cost: $q{('amount_' . $n)}\r\n"; 
      
      $table = $table . "Quantity: " . $q{('quantity_' . $n)} . "\r\n\r\n"; 
      
     my $line_total = $q{('amount_' . $n)} * $q{('quantity_' . $n)};
      
     $line_total = &sformat(($line_total));
      
    #  $table = $table . "$line_total"; 


      
      $item_total += $line_total;
       
      $n++;
      }  
     
      

    $table = $table . "Line Total" . &sformat(($item_total)) . "\r\n";    
      
      
     
 if($q{'shipping_1'} ne undef)
    {
 
    $table = $table . "Shipping: $q{'shipping_1'}\r\n";
    }
 
 if($q{'tax_cart'} ne undef)
    {
    $table = $table . "Tax: $q{'tax_cart'}\r\n";
    }
   

 $table = $table . "Order Total: $q{('OrderTotal')}";
	
$out .= $table;
 
return $out; 	
}




sub SetExpressCheckoutUK
{   
   
# Test Data

#$q{'currencyID'} = 'USD';

my %d;

if($UKusername eq '')
   {
   $d{'USER'} = $UKvendor; 
   }
else
   {
   $d{'USER'} = $UKusername; #Additional Users	
   }


$d{'VENDOR'} = $UKvendor;

$d{'PARTNER'} = $UKpartner;

$d{'PWD'} = $UKpassword;

$d{'TENDER'} = 'P';
$d{'ACTION'} = 'S';
$d{'TRXTYPE'} = $TRXTYPE;

$d{'AMT'} =  $u{'OrderTotal'};
$d{'RETURNURL'} =  $ReturnURL . '?s=t';
$d{'CANCELURL'} =  $CancelURL;
$d{'CURRENCY'} =  $currency_code;



use LWP::UserAgent;
my $ua = new LWP::UserAgent;
#my $req = new HTTP::Request POST => $URL;



my $req = new HTTP::Request POST => "https://$pfurl/transaction";
   $req->content_type('text/namevalue');
   $req->header('X-VPS-REQUEST-ID' => time,  # unique id
	     'X-VPS-CLIENT-TIMEOUT' => '45',
	     'X-VPS-VIT-CLIENT-CERTIFICATION-ID' => 'ssc3',
	     'X-VPS-VIT-INTEGRATION-PRODUCT' => 'Shopping Cart 3',
	     'X-VPS-VIT-INTEGRATION-VERSION' => '3.95',

#	     'X-VPS-VIT-OS-NAME' => $Config::Config{osname},
#	     'X-VPS-VIT-OS-VERSION' => $Config::Config{osvers},
	     'X-VPS-VIT-RUNTIME-VERSION' => $],

	     'Connection' => 'close',
	     'Host' => $pfurl,
	    );


while(my($first,$last) = each(%d))
   {
	   	   	    
   my $l = length($last);
   $req->add_content($first."[$l]=".$last.'&');
   
   print $first ."[$l]=" . $last . '&' .  "\r\n";	
   }
   
   $req->add_content('VERBOSITY=MEDIUM');

   $req->content_length(length(${$req->content_ref}));
  
  
	    
	    
my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 

# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG")
   {
   print"Content-Type: text/html\n\n";
   print "Debug Details 1: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";
   }


#RESULT=0&PNREF=V18A0D9D899C&RESPMSG=Approved&AUTHCODE=113PNI&AVSADDR=Y&AVSZIP=Y&HOSTCODE=A&PROCAVS=Y&IAVS=N


if($v{'RESULT'} eq "0")
   {
   &re_direct("https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$v{'TOKEN'}");
  
   }
else
   {
	
   if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

 
    print $v{"RESPMSG"} . " <br><br>\r\n";
    
    print "<script language='JavaScript'><!--\r\n" .
   "document.write('<br><br><input type=\"button\" value=\"Return\" name=\"b1\" onClick=\"history.go(-1)\">&nbsp;&nbsp;')" .           
   "\r\n--></script>";

    exit;

   }

exit;

}


#####################################

sub GetExpressCheckoutDetailsUK
{


my %d;

if($UKusername eq '')
   {
   $d{'USER'} = $UKvendor; 
   }
else
   {
   $d{'USER'} = $UKusername; #Additional Users	
   }


$d{'VENDOR'} = $UKvendor;

$d{'PARTNER'} = $UKpartner;

$d{'PWD'} = $UKpassword;

$d{'TENDER'} = 'P';
$d{'ACTION'} = 'G';


$d{'TRXTYPE'} = $TRXTYPE;

$d{'TOKEN'} =  $q{'token'};


use LWP::UserAgent;
my $ua = new LWP::UserAgent;
#my $req = new HTTP::Request POST => $URL;



my $req = new HTTP::Request POST => "https://$pfurl/transaction";
   $req->content_type('text/namevalue');
   $req->header('X-VPS-REQUEST-ID' => time,  # unique id
	     'X-VPS-CLIENT-TIMEOUT' => '45',
	     'X-VPS-VIT-CLIENT-CERTIFICATION-ID' => 'ssc3',
	     'X-VPS-VIT-INTEGRATION-PRODUCT' => 'Shopping Cart 3',
	     'X-VPS-VIT-INTEGRATION-VERSION' => '3.95',

#	     'X-VPS-VIT-OS-NAME' => $Config::Config{osname},
#	     'X-VPS-VIT-OS-VERSION' => $Config::Config{osvers},
	     'X-VPS-VIT-RUNTIME-VERSION' => $],

	     'Connection' => 'close',
	     'Host' => $pfurl,
	    );


while(my($first,$last) = each(%d))
   {
	   	   	    
   my $l = length($last);
   $req->add_content($first."[$l]=".$last.'&');
   
   print $first ."[$l]=" . $last . '&' .  "\r\n";	
   }
   
   $req->add_content('VERBOSITY=MEDIUM');

   $req->content_length(length(${$req->content_ref}));
  
    
	    
my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 


# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG")
   {
   print"Content-Type: text/html\n\n";
   print "Debug Details 1: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";
   }




if($v{'RESULT'} eq "0")
   {


# fills %order array when file is retrieved

my $table = &make_express_table();


my $output="";


$table = $table . 
 
"<table border='0' width='600' cellpadding='2'>
<tr>
<td  align='right'>
<form method='POST' action='paypal_pro.pl'>
<input type='hidden' name='token' value='$q{'token'}'>
<input type='hidden' name='s' value='c'>
<input type='hidden' name='PAYERID' value='$v{'PAYERID'}'>

<input type='hidden' name='FIRSTNAME' value='$v{'FIRSTNAME'}'>
<input type='hidden' name='LASTNAME' value='$v{'LASTNAME'}'>
<input type='hidden' name='SHIPTOSTREET' value='$v{'SHIPTOSTREET'}'>
<input type='hidden' name='SHIPTOCITY' value='$v{'SHIPTOCITY'}'>
<input type='hidden' name='SHIPTOSTATE' value='$v{'SHIPTOSTATE'}'>
<input type='hidden' name='SHIPTOZIP' value='$v{'SHIPTOZIP'}'>
<input type='hidden' name='SHIPTOCOUNTRY' value='$v{'SHIPTOCOUNTRY'}'>
<input type='hidden' name='PHONENUM' value='$v{'PHONENUM'}'>
<input type='hidden' name='EMAIL' value='$v{'EMAIL'}'>

<input type='submit' value='Place Order' name='B1'>
</form>
</td>
</tr>";
#</table>";


my $out="";

#(open (FILE_LIST,($doc_dir . "express.html")) ) || (&end_cgi ("Cannot read $doc_dir express.html: $!"));

#while (<FILE_LIST>)
#   {
#   $out = $out . $_;
#   }


$out = &express_form();

my $edit_button =
"<form method='POST' action='https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$q{'Token'}'>
<input type='submit' value='Edit' name='B1'>
</form>";



#RESULT=0
#RESPMSG=Approved
#AVSADDR=Y
#TOKEN=EC-17C76533PL706494P&PAYERID=FHY4JXY7CV9PG
#EMAIL=buyer_name@aol.com
#PAYERSTATUS=verified
#CUSTOM=TRVV14459
#FIRSTNAME=Chris
#LASTNAME=Alexander
#BUSINESS=Monroe Creek Regional Interiors
#SHIPTOSTREET=5262 Green Street
#SHIPTOCITY=San Jose
#SHIPTOSTATE=CA#
#SHIPTOZIP=95148
#SHIPTOCOUNTRY=US


$out =~ s/EditBilling/$edit_button/;     
$out =~ s/EditShipping/$edit_button/; 
$out =~ s/CustomerName/$v{'FIRSTNAME'} $v{'LASTNAME'}/; 
$out =~ s/ShipToBusiness/$v{'SHIPTOBUSINESS'}/; 
$out =~ s/Street1/$v{'SHIPTOSTREET'}/;
$out =~ s/Street2/$v{'SHIPTOSTREET2'}/;  
 
$out =~ s/CityName/$v{'SHIPTOCITY'}/;  
$out =~ s/StateorProvince/$v{'SHIPTOSTATE'}/;  
$out =~ s/PostalCode/$v{'SHIPTOZIP'}/;  
$out =~ s/CountryName/$v{'COUNTRYCODE'}/; 
$out =~ s/PhoneNumber/$v{'PHONENUM'}/; 
$out =~ s/PayPalName/$v{'EMAIL'}/;   
$out =~ s/<!--table-->/$table/;   
    
print $out;

#print $v{'SHIPTONAME'};

      
close(FILE_LIST);

exit;

}

else

   {
   if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

   my $s=0;
   while($v{"L_LONGMESSAGE$s"} ne undef)
      {
      print $v{"L_LONGMESSAGE$s"} . " <br><br>\r\n";
      $s++;	
      }

   exit;
    }
}

#####################################

sub end_cgi
   {
   my ($i) = @_;
	
   print"Content-Type: text/html; charset=ISO-8859-1$i\nend\n";

   exit;
   }


sub order_form
   {
      
   my $insert =""; 

   while(my($first,$last) = each(%q))
      {
      if(!($first =~ /submit/i)) 
         {	   
         $insert= $insert . "<input type='hidden' name='$first' value='$last'>" . "\r\n";	
         }
      }
   

   my $out="";   
      
#   my $file = $doc_dir . "direct.html";
#   (open (FILE_LIST, $file) ) || (&end_cgi ("Cannot read $file: $!"));
#   my $output="";
   
#   while (<FILE_LIST>)
#      {
#      $out = $out . $_;
#      }
      
   $out = &direct_order_form(); 
     
   $out =~ s/<!--paypal_pro_2-->/$insert/;  
      
   $insert= $insert . "<input type='hidden' name='s' value='o'>" . "\r\n";
   $out =~ s/<!--paypal_pro_1-->/$insert/;     
#$out =~ s/EditShipping/$edit_button/; 
 
   print $out;
   
   close(FILE_LIST);
   
   }


sub SetExpressCheckout
{   
   
# Test Data

#$q{'currencyID'} = 'USD';



my $APIrequest = "&METHOD=SetExpressCheckout" .

"&RETURNURL=". $ReturnURL . &uriescape('?s=t') .

"&CANCELURL=". $CancelURL .

"&AMT=". $u{'OrderTotal'}.

"&CURRENCYCODE=" . $currency_code .

"&PAYMENTACTION=" . $PAYMENTACTION;


#while(my ($first,$last) = each(%u))
#   {
#   $APIrequest .= '&' . "$first=$last";	
#   }

# post to PayPal

use LWP::UserAgent;
my $ua = new LWP::UserAgent;
my $req = new HTTP::Request POST => $URL;




#$req->content_type('application/x-www-form-urlencoded');
$req->content($AuthString.$APIrequest);

my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 


    
# Form variables to be saved either as temp file
      
#   my $output="";

#   while(my ($first,$last) = each(%q))
#      {
#      $output= $output . &uriescape($first) . '=' . &uriescape($last) . '&';	
#      }

  ## my $cookie = &uriescape($output); 
      
  ## if(length($cookie)>4096)
  ##   {  
  ##   $cookie = ""; 
  ##   }
      
  ## print "Set-Cookie: ssc=" ."test" . ";\n";
  
#   &clean_up();

#  &save_temp_file($v{'TOKEN'} . '.tmp',$output);
   
    
    

# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG"){
	
print "<br>$AuthString<br>$APIrequest";

print "Debug Details 2: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";

}


#TIMESTAMP=2008%2d01%2d29T20%3a01%3a08Z&
#CORRELATIONID=14e0679de397f&
#ACK=Success&
#VERSION=3%2e200000&
#BUILD=498001&
#TOKEN=EC%2d9A966090KW129300C



if($v{'ACK'} eq "Success")
   {

   #(open (FILE_LIST,($doc_dir . "success.html")) ) || (&end_cgi ("Cannot read $doc_dir success.html: $!"));


   &re_direct("https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$v{'TOKEN'}");
   
   }
else
   {
 
   if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

   my $s=0;
   while($v{"L_LONGMESSAGE$s"} ne undef)
      {
      print $v{"L_LONGMESSAGE$s"} . " <br><br>\r\n";
      $s++;	
      }

   exit;
   
   }   



}







sub GetExpressCheckoutDetails
{

#$q{'Token'} = 

#token=EC-44U454365A6316423&PayerID=E99VBBTXGKDJC

#&METHOD=GetExpressCheckoutDetails&TOKEN=".$ECToken

my $APIrequest = "&METHOD=GetExpressCheckoutDetails" .

"&TOKEN=". $q{'token'};

                        
# post to PayPal

use LWP::UserAgent;
my $ua = new LWP::UserAgent;
my $req = new HTTP::Request POST => $URL;


#$req->content_type('application/x-www-form-urlencoded');
$req->content($AuthString.$APIrequest);

my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 


# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG"){
	
print "<br>$AuthString<br>$APIrequest";
print $AuthString.$APIrequest;
print "Debug Details GetExpressDetails: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";
}




if($v{'ACK'} eq "Success")
   {


#while(($first,$last) = each(%q))
#   {
#   if(!($first =~ /submit/i)) 
#      {	   
#      $insert= $insert . "<input type='hidden' name='$first' value='$last'>" . "\r\n";	
#      }
#   }
   
# fills %order array when file is retrieved

my $table = &make_express_table();


# Save paypal response includer payer id

my $output="";

## while(my ($first,$last) = each(%order))
##    {
##    $first =~ s/^\s+//;	   
##    if($first ne "")
##       {	   
##       $output= $output . $first . "|ssc3"  . $last . "\r\n";	
##       }
##    }


## while(my ($first,$last) = each(%v))
##    {
##    $first =~ s/^\s+//;	   
##    if($first ne "")
##       {	   
##       $output= $output . $first . "|ssc3"  . $last . "\r\n";	
##       }
##    }

## &save_temp_file($q{'token'} . '.tmp',$output);



$table = $table . 
 
"<table border='0' width='600' cellpadding='2'>
<tr>
<td  align='right'>
<form method='POST' action='paypal_pro.pl'>
<input type='hidden' name='token' value='$q{'token'}'>
<input type='hidden' name='s' value='c'>
<input type='hidden' name='PAYERID' value='$v{'PAYERID'}'>

<input type='hidden' name='SHIPTONAME' value='$v{'SHIPTONAME'}'>
<input type='hidden' name='SHIPTOSTREET' value='$v{'SHIPTOSTREET'}'>
<input type='hidden' name='SHIPTOSTREET2' value='$v{'SHIPTOSTREET2'}'>
<input type='hidden' name='SHIPTOCITY' value='$v{'SHIPTOCITY'}'>
<input type='hidden' name='SHIPTOSTATE' value='$v{'SHIPTOSTATE'}'>
<input type='hidden' name='SHIPTOZIP' value='$v{'SHIPTOZIP'}'>
<input type='hidden' name='COUNTRYCODE' value='$v{'COUNTRYCODE'}'>
<input type='hidden' name='EMAIL' value='$v{'EMAIL'}'>
<input type='hidden' name='PHONENUM' value='$v{'PHONENUM'}'>
<input type='submit' value='Place Order' name='B1'>
</form>
</td>
</tr>";
#</table>";


my $out="";

#(open (FILE_LIST,($doc_dir . "express.html")) ) || (&end_cgi ("Cannot read $doc_dir express.html: $!"));

#while (<FILE_LIST>)
#   {
#   $out = $out . $_;
#   }


$out = &express_form();

my $edit_button =
"<form method='POST' action='https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$q{'Token'}'>
<input type='submit' value='Edit' name='B1'>
</form>";

#EMAIL=testing%40online%2dstore%2eco%2euk&
#PAYERID=E99VBBTXGKDJC&
#PAYERSTATUS=verified&
#FIRSTNAME=Joe&LASTNAME=Sheehan&
#COUNTRYCODE=US&
#SHIPTONAME=Joe%20Sheehan&
#SHIPTOSTREET=101%20test&
#SHIPTOCITY=New%20York&
#SHIPTOSTATE=NY&
#SHIPTOCOUNTRYCODE=US&
#SHIPTOCOUNTRYNAME=United%20States&
#SHIPTOZIP=12233&
#ADDRESSID=PayPal&
#ADDRESSSTATUS=Unconfirmed


$out =~ s/EditBilling/$edit_button/;     
$out =~ s/EditShipping/$edit_button/; 
$out =~ s/CustomerName/$v{'SHIPTONAME'}/;     
$out =~ s/Street1/$v{'SHIPTOSTREET'}/;  
$out =~ s/Street2/$v{'SHIPTOSTREET2'}/;  
$out =~ s/CityName/$v{'SHIPTOCITY'}/;  
$out =~ s/StateorProvince/$v{'SHIPTOSTATE'}/;  
$out =~ s/PostalCode/$v{'SHIPTOZIP'}/;  
$out =~ s/CountryName/$v{'COUNTRYCODE'}/;  
$out =~ s/PayPalName/$v{'EMAIL'}/;   
$out =~ s/<!--table-->/$table/;   
    
print $out;

#print $v{'SHIPTONAME'};

      
close(FILE_LIST);

exit;

}

else

   {
   if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

   my $s=0;
   while($v{"L_LONGMESSAGE$s"} ne undef)
      {
      print $v{"L_LONGMESSAGE$s"} . " <br><br>\r\n";
      $s++;	
      }

   exit;
    }
}

sub DoExpressCheckoutPayment
{

$q{'Token'} = $q{'token'};


######################################################


my $ipaddress = $ENV{"REMOTE_ADDR"};


my $APIrequest="";	   

my $item_total = 0;

#if($order{'tax_1'} eq undef)
#  {
#  $order{'tax_1'} = "";	
#  }


  
if($order{'shipping_1'} eq undef)
  {
  $order{'shipping_1'} = "";	  
  }	  


  
my $order='';
  
for(my $n=1;$order{"item_name_$n"} ne undef;$n++)
   {
	   
   $item_total = $item_total + ($u{"quantity_$n"} * $u{"amount_$n"});
	   
  # if($n>1)
  #    { 	       
  #    if($order{"tax_1"} eq "")
  #       {
  #       $order{"tax_$n"} ="";
  #       }   
  #    else
  #       {
  #       $order{"tax_$n"} ="0.00";
  #       } 
  #    } 
  	
   my $item_number = $order{"item_number_$n"};   
          
   if($order{"pro_on0_$n"} ne undef)
      {
      $item_number = $item_number . " - " . $order{"pro_on0_$n"} . ":" . $order{"pro_os0_$n"};
      }
   
   if($order{"pro_on1_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $order{"pro_on1_$n"} . ":" . $order{"pro_os1_$n"};
      }
  
   if($order{"pro_on2_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $order{"pro_on2_$n"} . ":" . $order{"pro_os2_$n"};
      }
      
    $order{"item_number_$n"} = $item_number;  
   
    my $i=$n-1;
         
    $order .= 
    '&L_NAME' . "$i=" . $order{"item_name_$n"} .
    '&L_NUMBER' . "$i=" . $order{"item_number_$n"} .
    '&L_QTY' . "$i=" . $order{"quantity_$n"} .  
    '&L_AMT' . "$i=" . $order{"amount_$n"}; 

   }
	  

   
     

#&METHOD=DoExpressCheckoutPayment&
#TOKEN=".$ECToken."&
#PAYERID=".$PayerID."&
#AMT=5.00&
#DESC=NVP_perlExpressCheckoutPayment&
#PAYMENTACTION=Authorization";
   
$APIrequest = '&METHOD=DoExpressCheckoutPayment' .

'&PAYMENTACTION=' . $PAYMENTACTION .


'&AMT=' . $order{'OrderTotal'} .

'&PAYERID=' . $q{'PAYERID'} .



'&ITEMAMT=' . $order{'ITEMAMT'} .


'&SHIPPINGAMT=' . $order{'shipping_1'} .

'&TAXAMT=' .  $order{'tax_cart'} .

'&TOKEN=' . $q{'token'} .

"&CURRENCYCODE=" . $currency_code .

# subtotals

#'&ITEMAMT=' . $u{'OrderTotal'} .

#"&DESC=NVP_perl_DirectPaymentExample" .

$order;



#if($order{'delivery_address'} eq "ON")
#   {
#   $order{'del_name'} = $order{'cc_first_name'} . " " . $order{'cc_last_name'} ;   
#   $order{'del_addr1'} = $order{'cc_addr1'};	   
#   $order{'del_addr2'} = $order{'cc_addr2'};
#   $order{'del_city'} = $order{'cc_city'};
#   $order{'del_state'} = $order{'cc_city'};
#   $order{'del_country'} = $order{'cc_country'};
#   $order{'del_postalcode'} = $order{'cc_postalcode'};
#   }


if($order{"pro_shipping"} eq undef)
   {
   $order{"pro_shipping"} ="";
   }
   


# once we have the reqeust string built, let's make the call by sending it to PayPal
# post to PayPal
use LWP::UserAgent;
my $ua = new LWP::UserAgent;
my $req = new HTTP::Request POST => $URL;




# set header stuff
#$req->content_type('application/x-www-form-urlencoded');
$req->content($AuthString.$APIrequest);

my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 


# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG"){
print "$APIrequest<br>";
print "Debug Details 1: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";
}

#exit;


my $table = &make_express_table();

my $out="";

if($v{'ACK'} eq 'Success')
{

	
	
my $APIrequest = "&METHOD=GetExpressCheckoutDetails" .

"&TOKEN=". $q{'token'};

                        
# post to PayPal

use LWP::UserAgent;
my $ua = new LWP::UserAgent;
my $req = new HTTP::Request POST => $URL;


#$req->content_type('application/x-www-form-urlencoded');
$req->content($AuthString.$APIrequest);

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
		
	
	
#(open (FILE_LIST,($doc_dir . "express_success.html")) ) || (&end_cgi ("Cannot read $doc_dir success.html: $!"));


#while (<FILE_LIST>)
#   {
#   $out = $out . $_;
#   }

$out = &express_success();

my $edit_button =
"<form method='POST' action='https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$q{'Token'}'>
<input type='submit' value='Edit' name='B1'>
</form>";


$out =~ s/EditBilling/$edit_button/;     
$out =~ s/EditShipping/$edit_button/; 
$out =~ s/ShippingCustomerName/$q{'SHIPTONAME'}/;     
$out =~ s/ShippingStreet1/$q{'SHIPTOSTREET'}/;  
$out =~ s/ShippingStreet2/$q{'SHIPTOSTREET2'}/;  
$out =~ s/ShippingCityName/$q{'SHIPTOCITY'}/;  
$out =~ s/ShippingStateorProvince/$q{'SHIPTOSTATE'}/;  
$out =~ s/ShippingPostalCode/$q{'SHIPTOZIP'}/;  
$out =~ s/ShippingCountryName/$q{'COUNTRYCODE'}/;  
$out =~ s/PayPalName/$q{'EMAIL'}/; 
$out =~ s/PhoneNumber/$q{'PHONENUM'}/; 
$out =~ s/PayPalTransactionID/$v{'TRANSACTIONID'}/; 
$out =~ s/<!--table-->/$table/;  


#xxxxxxxxxxxxxxxxxxxxxxxx
    
print $out;

      
close(FILE_LIST);

}
else
{


   if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

   my $s=0;
   while($v{"L_LONGMESSAGE$s"} ne undef)
      {
      print $v{"L_LONGMESSAGE$s"} . " <br><br>\r\n";
      $s++;	
      }

   exit;

}


#print &make_email();

#$out = "Order Details\r\n\r\n" .

#$order{"Name"} . "\r\n" .
#$order{"Street1"} . "\r\n" .
#$order{"Street2"} . "\r\n" . 
#$order{"CityName"} . "\r\n" . 
#$order{"StateOrProvince"} . "\r\n" . 
#$order{"PostalCode"} . "\r\n" .
#$order{"CountryName"} . "\r\n";

#my $order_details = &order();

#$out = $out . $order_details;

#print "<br>$out<br><br>";

#my $sender= $order{"Payer"};

#print "$sender<br>";

#my $e_mail_address = 'test@test.com';


my $email_details = "Name: $q{'SHIPTONAME'}

Street: $q{'SHIPTOSTREET'} 

$q{'SHIPTOSTREET2'}

City: $q{'SHIPTOCITY'}

StateorProvince: $q{'SHIPTOSTATE'}

ZipCode: $q{'SHIPTOZIP'}

Country: $q{'COUNTRYCODE'}

Email: $q{'EMAIL'}

PhoneNumber: $q{'PHONENUM'}

PayPal Transaction ID: $v{'TRANSACTIONID'}
";

my $email_table = &make_email_table();

$email_details .= $email_table;

#my $output = "This is a test\n";

open(MAIL,"| " . $sendmail . " -t") || (&end_cgi ("Cannot read open SendMail "));
              
print MAIL "From: " . $q{'EMAIL'} . "\n";
print MAIL "To: " . $merchant_email . "\n";

# Check for Message Subject
print MAIL "Subject: Customer Orders \n\n";

print MAIL "$email_details\n";
         
close(MAIL);
         
#&end_cgi("OK: Transmission Received $]");


exit;
}


sub DoExpressCheckoutPaymentUK
{

$q{'Token'} = $q{'token'};


######################################################


my $ipaddress = $ENV{"REMOTE_ADDR"};


my $APIrequest="";	   

my $item_total = 0;

#if($order{'tax_1'} eq undef)
#  {
#  $order{'tax_1'} = "";	
#  }


  
if($order{'shipping_1'} eq undef)
  {
  $order{'shipping_1'} = "";	  
  }	  


  
my $order='';
  

my %d;


for(my $n=1;$order{"item_name_$n"} ne undef;$n++)
   {
	   
    $item_total = $item_total + ($u{"quantity_$n"} * $u{"amount_$n"});  
	   
#   if($n>1)
#      { 	       
#      if($order{"tax_1"} eq "")
#         {
#         $order{"tax_$n"} ="";
#         }   
#      else
#         {
#         $order{"tax_$n"} ="0.00";
#         } 
#      } 


  	
   my $item_number = $order{"item_number_$n"};   
          
   if($order{"pro_on0_$n"} ne undef)
      {
      $item_number = $item_number . " - " . $order{"pro_on0_$n"} . ":" . $order{"pro_os0_$n"};
      }
   
   if($order{"pro_on1_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $order{"pro_on1_$n"} . ":" . $order{"pro_os1_$n"};
      }
  
   if($order{"pro_on2_$n"} ne undef)
      {
      $item_number  =  $item_number  . " - " . $order{"pro_on2_$n"} . ":" . $order{"pro_os2_$n"};
      }
      
    $order{"item_number_$n"} = $item_number;    
   
    my $i=$n-1;
         
    $order .= 
   #$d{"L_DESC$i"} = "12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890";
   $d{"L_DESC$i"} =  $order{"item_number_$n"} . ' - ' . $order{"item_name_$n"};
   #$d{"L_DESC$i"} = substr($d{"L_DESC$i"},0,127);
   # $order{"item_number_$n"} .
    $d{"L_QTY$i"} = $order{"quantity_$n"};  
    $d{"L_AMT$i"} = $order{"amount_$n"};
    
     if($order{"L_TAXAMT$i"} ne undef)
        {
        $d{"L_TAXAMT$i"} =  $order{"L_TAXAMT$i"};
        }

   }
	  



#<input type='hidden' name='FIRSTNAME' value='$v{'FIRSTNAME'}'>
#<input type='hidden' name='LASTNAME' value='$v{'LASTNAME'}'>
#<input type='hidden' name='SHIPTOSTREET' value='$v{'SHIPTOSTREET'}'>
#<input type='hidden' name='SHIPTOCITY' value='$v{'SHIPTOCITY'}'>
#<input type='hidden' name='SHIPTOSTATE' value='$v{'SHIPTOSTATE'}'>
#<input type='hidden' name='SHIPTOZIP' value='$v{'SHIPTOZIP'}'>
#<input type='hidden' name='SHIPTOCOUNTRY' value='$v{'SHIPTOCOUNTRY'}'>
#<input type='hidden' name='EMAIL' value='$v{'EMAIL'}'>


if($order{"pro_shipping"} eq undef)
   {
   $order{"pro_shipping"} ="";
   }
   
###########################################################


if($UKusername eq '')
   {
   $d{'USER'} = $UKvendor; 
   }
else
   {
   $d{'USER'} = $UKusername; #Additional Users	
   }


   

#HANDLINGAMT
#INVNUM
#NOTIFYURL
#ORDERDESC   
   
   
$d{'VENDOR'} = $UKvendor;

$d{'PARTNER'} = $UKpartner;

$d{'PWD'} = $UKpassword;

$d{'TENDER'} = 'P';

$d{'ACTION'} = 'D';  #Do Express Payment UK

$d{'TRXTYPE'} = $TRXTYPE;

$d{'TOKEN'} =  $q{'token'};

$d{'PAYERID'} = $q{'PAYERID'};

$d{'AMT'} = $order{'OrderTotal'};

$d{'ITEMAMT'} =   $order{'ITEMAMT'};

$d{'FRIEGHTAMT'} = $order{'shipping_1'};

$d{'TAXAMT'} =  $order{'tax_cart'};


$d{'CURRENCY'} = $currency_code;

$d{'ORDERDESC'}="Order Description";

$d{'COMMENT1'} = substr($order{'short_desc'},0,128);
$d{'COMMENT2'} = substr($order{'short_desc'},128,255);

$d{'CUSTOM'} = substr($order{'short_desc'},0,255);


#####################################################

#direct variables

$d{'PHONENUM'} = $q{'cc_telephone'};

$d{'INVNUM'} = $$;
#################################################################

#$d{'INVNUM'} = $$;

#$d{'DESC'} = "Test invoice $$";


use LWP::UserAgent;
my $ua = new LWP::UserAgent;
#my $req = new HTTP::Request POST => $URL;



my $req = new HTTP::Request POST => "https://$pfurl/transaction";
   $req->content_type('text/namevalue');
   $req->header('X-VPS-REQUEST-ID' => time,  # unique id
	     'X-VPS-CLIENT-TIMEOUT' => '45',
	     'X-VPS-VIT-CLIENT-CERTIFICATION-ID' => 'ssc3',
	     'X-VPS-VIT-INTEGRATION-PRODUCT' => 'Shopping Cart 3',
	     'X-VPS-VIT-INTEGRATION-VERSION' => '3.95',

#	     'X-VPS-VIT-OS-NAME' => $Config::Config{osname},
#	     'X-VPS-VIT-OS-VERSION' => $Config::Config{osvers},
	     'X-VPS-VIT-RUNTIME-VERSION' => $],

	     'Connection' => 'close',
	     'Host' => $pfurl,
	    );


while(my($first,$last) = each(%d))
   {
	   	   	    
   my $l = length($last);
   $req->add_content($first."[$l]=".$last.'&');
   
   print $first ."[$l]=" . $last . '&' .  "\r\n";	
   }
   
   $req->add_content('VERBOSITY=MEDIUM');

   $req->content_length(length(${$req->content_ref}));
  
  
# $req->content_length(length(${$req->content_ref}));
#$AuthString = "USER=".$APIusername."&PWD=".$APIpassword."&SIGNATURE=".$APIsignature."&VERSION=50.0";
	    
	    
	    
my %v;

# get response
my $res = $ua->request($req);

# parse response into name/value pairs
 my @pairs = split(/&/,  $res->content);
 my $count = 0;
 foreach my $pair (@pairs)
    {
    my ($name, $value) = split(/=/, $pair);
    $value =~ tr/+/ /;
    $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
    $v{$name} = $value;
    $count++;
    }
 


# This line prints the ENTIRE response string - for DEBUG
if ($scriptMODE eq "DEBUG")
   {
   print"Content-Type: text/html\n\n";
   print "Debug Details 1: the RESPONSE WAS: <br><br>".$res->content."<br><hr>";
   }




my $table = &make_express_table();

my $out="";   
   
   
   
if($v{'RESULT'} eq "0")
   {


(open (FILE_LIST,($doc_dir . "express_success.html")) ) || (&end_cgi ("Cannot read $doc_dir success.html: $!"));


#while (<FILE_LIST>)
#   {
#   $out = $out . $_;
#   }

$out = &express_success();

my $edit_button =
"<form method='POST' action='https://www.$paypal_url/cgi-bin/webscr?cmd=_express-checkout&token=$q{'Token'}'>
<input type='submit' value='Edit' name='B1'>
</form>";


$out =~ s/EditBilling/$edit_button/;     
$out =~ s/EditShipping/$edit_button/; 
$out =~ s/ShippingCustomerName/$q{'SHIPTONAME'}/;     
$out =~ s/ShippingStreet1/$q{'SHIPTOSTREET'}/;  
#$out =~ s/ShippingStreet2/$v{''}/;  
$out =~ s/ShippingCityName/$q{'SHIPTOCITY'}/;  
$out =~ s/ShippingStateorProvince/$q{'SHIPTOSTATE'}/;  
$out =~ s/ShippingPostalCode/$q{'SHIPTOZIP'}/;  
$out =~ s/ShippingCountryName/$q{'COUNTRYCODE'}/;  
$out =~ s/PayPalName/$q{'EMAIL'}/;  
$out =~ s/PayPalTransactionID/$v{'TRANSACTIONID'}/; 
$out =~ s/<!--table-->/$table/;  


#xxxxxxxxxxxxxxxxxxxxxxxx
    
print $out;

      
close(FILE_LIST);


if($merchant_email ne '')
   {

   my $message = &make_email();	   
	   
   open(MAIL,"| " . $sendmail . " -t") || (&end_cgi ("Cannot read open SendMail "));
              
   print MAIL "From: " . $q{'EMAIL'} . "\n";
   print MAIL "To: " . $merchant_email . "\n";

# Check for Message Subject
   print MAIL "Subject: Customer Orders \n\n";

   print MAIL "$message\n";
         
   close(MAIL);
   
   print $message;
      
   }

}
else
{



if ($scriptMODE eq "DEBUG")
      {

      while(my ($first,$last) = each(%v))
         {
	     print "$first: $last <br><br>\r\n";      
         }      
      }

 
    print $v{"RESPMSG"} . " <br><br>\r\n";
    
    print "<script language='JavaScript'><!--\r\n" .
   "document.write('<br><br><input type=\"button\" value=\"Return\" name=\"b1\" onClick=\"history.go(-1)\">&nbsp;&nbsp;')" .           
   "\r\n--></script>";

    exit;


}

exit;


}





sub make_express_table
   {
 #  my ($file)=@_;
   #my %order;
   
 #  ( open (FILE_LIST, $file) ) || (&end_cgi ("Cannot read $file: $!"));
   
 #  while (<FILE_LIST>)
 #     {
     
 #     my ($first,$last) = split(/\|ssc3/,$_);
      
 #      chop($last); 
 #      chop($last); 
      
 #  if(!($first =~ /submit/i))
  
 #     {	   
 #     $order{$first}=$last;	
      
   
 #  }

   
         
 #  }
      

 #  close(FILE_LIST);

 my  $n=1;
   
 my $table=""  ;
 
 
   my $item_total = 0;
   
   while($order{('quantity_' . $n)} ne undef)   
      {
      $table = $table . "<tr>"; 
      

      $table = $table . "<td valign=\"top\">$order{('item_name_' . $n)}"; 
      
      if($order{('pro_on0_' . $n)} ne undef)
         {
          $table = $table . "<br>$order{'pro_on0_' . $n}:$order{'pro_os0_' . $n}";
         }
      
      if($order{('pro_on1_' . $n)} ne undef)
         {
         $table = $table . "<br>$order{'pro_on1_' . $n}:$order{'pro_os1_' . $n}";
         }   
         
      if($order{('pro_on2_' . $n)} ne undef)
         {
         $table = $table . "<br>$order{'pro_on2_' . $n}:$order{'pro_os2_' . $n}";
         }   
                
      
      if($order{('item_number_' . $n)} ne "")
         {
         $table = $table . "<br>$order{('item_number_' . $n)}";
         }    
               
         
          
      $table = $table . "</td>"; 
      
      $table = $table . "<td valign=\"top\" align=\"right\">" . &tformat($order{('amount_' . $n)}) . "</td>"; 
      
      $table = $table . "<td valign=\"top\" align=\"right\">$order{('quantity_' . $n)}</td>"; 
      
      my $line_total = $order{('amount_' . $n)} * $order{('quantity_' . $n)};
      
      $line_total = &sformat(($line_total));
      
      $table = $table . "<td valign=\"top\" align=\"right\">\&nbsp;\&nbsp;" . &tformat($line_total) . "</td>"; 
  
      
      $table = $table . "</tr>"; 
      
      $item_total += $line_total;
       
      $n++;
      }  
     
      
    $table = $table . "<tr>";
    $table = $table . "<td colspan='3'><p align='right'>Item Total:\&nbsp;</td>";
    $table = $table . "<td align='right'>\&nbsp;" . &tformat(($item_total)) . "</td></tr>";    
      
      
     
 if($order{'shipping_1'} ne undef)
    {
    $table = $table . "<tr>";
    $table = $table . "<td colspan='3'><p align='right'>Shipping:\&nbsp;</td>";
    $table = $table . "<td align='right'>\&nbsp;" . &tformat($order{'shipping_1'}) . "</td></tr>";
    }
 
 if($order{'tax_cart'} ne undef)
    {
   
    $table = $table . "<tr>";
    $table = $table . "<td colspan='3'><p align='right'>$sales_tax:\&nbsp;</td>";
    $table = $table . "<td align='right'>\&nbsp;" . &tformat($order{'tax_cart'}) . "</td></tr>";
    }
   
 $table = $table . "<tr>";
 $table = $table . "<td  colspan='3'><p align='right'>Order Total:\&nbsp;</td>";
 $table = $table . "<td align='right'>\&nbsp;" . &tformat($order{'OrderTotal'}) . "</td></tr>";
 
 $table = $table . "</table>";      
      


 return $table;
 }  

sub make_email_table
   {

 my  $n=1;
   
 my $table=""  ;
 
 
   my $item_total = 0;
   
   while($order{('quantity_' . $n)} ne undef)   
      {
  

      $table .= "$order{('item_name_' . $n)}"; 
      
      if($order{('pro_on0_' . $n)} ne undef)
         {
          $table .= "\r\n$order{'pro_on0_' . $n}:$order{'pro_os0_' . $n}";
         }
      
      if($order{('pro_on1_' . $n)} ne undef)
         {
         $table .= "\r\n$order{'pro_on1_' . $n}:$order{'pro_os1_' . $n}";
         }   
         
      if($order{('pro_on2_' . $n)} ne undef)
         {
         $table .= "\r\n$order{'pro_on2_' . $n}:$order{'pro_os2_' . $n}";
         }   
                
      
      if($order{('item_number_' . $n)} ne "")
         {
         $table .= "\r\n$order{('item_number_' . $n)}";
         }    
               
         
          
      $table .=  "\r\n(" . &tformat($order{('amount_' . $n)}) . ' x ' . $order{('quantity_' . $n)}; 
      
      my $line_total = $order{('amount_' . $n)} * $order{('quantity_' . $n)};
      
      $line_total = &sformat(($line_total));
      
      $table .= ")  " . &tformat($line_total); 
  
      
      $table .= "\r\n"; 
      
      $item_total += $line_total;
       
      $n++;
      }  
     
      
    $table .= "\r\nItem Total: " . &tformat(($item_total)) . "\r\n";    
      
      
     
 if($order{'shipping_1'} ne undef)
    {
    $table .= "Shipping: " . &tformat($order{'shipping_1'}) . "\r\n";
    }
 
 if($order{'tax_cart'} ne undef)
    {
   
    $table .= "$sales_tax: " . &tformat($order{'tax_cart'}) . "\r\n";
    }
   

 $table .= "\r\nOrder Total: " . &tformat($order{'OrderTotal'});
     
      


 return $table;
 }  

 
 
 sub make_table # direct payment
 {
 
  my  $n=1;
   
 my $table=""  ;
 
 
   my $item_total = 0;
   
   while($q{('quantity_' . $n)} ne undef)   
      {
      $table = $table . "<tr>"; 
      

      $table = $table . "<td valign=\"top\">$q{('item_name_' . $n)}"; 
      
      if($q{('pro_on0_' . $n)} ne undef)
         {
          $table = $table . "<br>$q{'pro_on0_' . $n}:$q{'pro_os0_' . $n}";
         }
      
      if($q{('pro_on1_' . $n)} ne undef)
         {
         $table = $table . "<br>$q{'pro_on1_' . $n}:$q{'pro_os1_' . $n}";
         }   
         
      if($q{('pro_on2_' . $n)} ne undef)
         {
         $table = $table . "<br>$q{'pro_on2_' . $n}:$q{'pro_os2_' . $n}";
         }   
                
      
      if($q{('item_number_' . $n)} ne "")
         {
         $table = $table . "<br>$q{('item_number_' . $n)}";
         }    
               
         
          
      $table = $table . "</td>"; 
      
      $table = $table . "<td valign=\"top\" align=\"right\">" . &tformat($q{('amount_' . $n)}) . "</td>"; 
      
      $table = $table . "<td valign=\"top\" align=\"right\">$q{('quantity_' . $n)}</td>"; 
      
      my $line_total = $q{('amount_' . $n)} * $q{('quantity_' . $n)};
      
      $line_total = &sformat(($line_total));
      
      $table = $table . "<td valign=\"top\" align=\"right\">\&nbsp;\&nbsp;" . &tformat($line_total) . "</td>"; 

           
  
      
       $table = $table . "</tr>"; 
      
      $item_total += $line_total;
       
      $n++;
      }  
     
      
    $table = $table . "<tr>";
    $table = $table . "<td colspan='3'><p align='right'>Item Total:\&nbsp;</td>";
    $table = $table . "<td align='right'>\&nbsp;" . &tformat($item_total) . "</td></tr>";    
      
      
     
 if($q{'shipping_1'} ne undef)
    {
    $table = $table . "<tr>";
    $table = $table . "<td colspan='3'><p align='right'>Shipping:\&nbsp;</td>";
    $table = $table . "<td align='right'>\&nbsp;" . &tformat($q{'shipping_1'}) . "</td></tr>";
    }
 
 if($q{'tax_cart'} ne undef)
    {
   
    $table = $table . "<tr>";
    $table = $table . "<td colspan='3'><p align='right'>$sales_tax:\&nbsp;</td>";
    $table = $table . "<td align='right'>\&nbsp;" . &tformat($q{'tax_cart'}) . "</td></tr>";
    }
   
 $table = $table . "<tr>";
 $table = $table . "<td  colspan='3'><p align='right'>Order Total:\&nbsp;</td>";
 $table = $table . "<td align='right'>\&nbsp;" . &tformat($q{'OrderTotal'}) . "</td></tr>";
 
 $table = $table . "</table>";      
      


return $table;
 }  
 
   
   
sub express_form
   {
   my $output = '<html>

<head>
<title>PayPal Payments Express test</title>
</head>

<body onload="focus();" bgcolor="#FFFFFF" text="#000000"
style="font-family: Arial; font-size: 10">

<p><font face="Arial" size="3" color="#008080"><strong>Place Order</strong></font></p>

<p><font face="Arial" color="#000000" size="2">Please review all the information below and
click the "Place Order Button" to complete your order.</font></p>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"><font face="Arial" size="2" color="#FFFFFF"><strong>Fast, Secure Checkout
    with PayPal</strong></font></td>
  </tr>
</table>

<table border="0" width="623" cellspacing="0" cellpadding="4" height="45">
  <tr>
    <td width="180"><p align="right"><strong><font face="Arial" size="2">Shipping
    Address: </font></strong></td>
    <td align="left" width="407">CustomerName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">Street1</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">Street2</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">CityName, PostalCode</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">StateorProvince</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">CountryName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp;&nbsp;</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">EditShipping</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp; </td>
  </tr>
</table>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"><font face="Arial" size="2" color="#FFFFFF"><strong>Billing Information</strong></font></td>
  </tr>
</table>

<table border="0" width="623" cellspacing="0" cellpadding="4" height="45">';
#  <tr>
#    <td height="1" width="192"><p align="right"><strong><font face="Arial" size="2">Payment
#    Method: </font></strong></td>
#    <td align="left" width="441">PayPal Account</td>
#  </tr>
$output .= '<tr>
    <td height="1" width="192"></td>
    <td align="left" width="441">PayPalName</td>
  </tr>
  <tr>
    <td height="1" width="192"></td>
    <td align="left" width="441">EditBilling</td>
  </tr>
</table>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"><font face="Arial" size="2" color="#FFFFFF"><strong>Order Details</strong></font></td>
  </tr>
</table>

<p>&nbsp;</p>

<table border="1" width="600" cellspacing="0" cellpadding="2">
  <tr>
    <td style="background-color: rgb(220,220,220)" width="450"><strong><font face="Arial"
    size="2">Item</font></strong></td>
    <td style="background-color: rgb(220,220,220)" width="50"><font face="Arial" size="2"><strong>Unit Price</strong></font></td>
    <td style="background-color: rgb(220,220,220)" width="50"><strong><font face="Arial"
    size="2">Quantity</font></strong></td>
    <td style="background-color: rgb(220,220,220)" width="50"><strong><font face="Arial"
    size="2">Totals</font></strong></td>
  </tr>
<!--table-->
</table>
</body>
</html>';

return $output;
}	   
 
 
sub express_success
{

my $output =
'<html>

<head>
<title>Completed Order</title>
</head>

<body onload="focus();" bgcolor="#FFFFFF" text="#000000"
style="font-family: Arial; font-size: 10">

<p><font face="Arial" size="3" color="#FF0000"><strong>Your Order is Complete</strong></font></p>

<p><font face="Arial" color="#000000" size="2">Please print this receipt for your records.</font></p>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"></td>
  </tr>
</table>

<table border="0" width="623" cellspacing="0" cellpadding="4" height="23">
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp; </td>
  </tr>
  <tr>
    <td width="180"><p align="right"><strong><font face="Arial" size="2">Shipping
    Address: </font></strong></td>
    <td align="left" width="407">ShippingCustomerName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingStreet1</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingStreet2</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingCityName, ShippingPostalCode</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingStateorProvince</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingCountryName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp;&nbsp;</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp; </td>
  </tr>
</table>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"><font face="Arial" size="2" color="#FFFFFF"><strong>Billing Information</strong></font></td>
  </tr>
</table>

<table border="0" width="623" cellspacing="0" cellpadding="4" height="45">';

#  <tr>
#    <td width="192"><p align="right"><strong><font face="Arial" size="2">Payment
#    Method: </font></strong></td>
#    <td align="left" width="441">PayPal Account</td>
#  </tr>

  $output .= '<tr>
    <td width="192"></td>
    <td align="left" width="441">PayPalName</td>
  </tr>
  <tr>
    <td width="192">&nbsp;&nbsp;</td>
    <td align="left" width="441"></td>
  </tr>
  <tr>
    <td width="192"><p align="right"><strong><font face="Arial" size="2">PayPal
    Transaction ID:</font></strong></td>
    <td align="left" width="441">PayPalTransactionID</td>
  </tr>
</table>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"><font face="Arial" size="2" color="#FFFFFF"><strong>Order Details</strong></font></td>
  </tr>
</table>

<p>&nbsp; </p>


<table border="1" width="600" cellspacing="0" cellpadding="2">
  <tr>
    <td style="background-color: rgb(220,220,220)" width="450"><strong><font face="Arial"
    size="2">Item</font></strong></td>
    <td style="background-color: rgb(220,220,220)" width="50"><font face="Arial" size="2"><strong>Unit Price</strong></font></td>
    <td style="background-color: rgb(220,220,220)" width="50"><strong><font face="Arial"
    size="2">Quantity</font></strong></td>
    <td style="background-color: rgb(220,220,220)" width="50"><strong><font face="Arial"
    size="2">Totals</font></strong></td>
  </tr>
<!--table-->
</table>
</body>
</html>';

return $output;	
	
} 
 
sub direct_success_form
{

my $output="";
		
$output = '<html>

<head>
<title>Completed Order</title>
</head>

<body onload="focus();" bgcolor="#FFFFFF" text="#000000"
style="font-family: Arial; font-size: 10">

<p><font face="Arial" size="3" color="#008080"><strong>Your Order is Complete</strong></font></p>

<p><font face="Arial" color="#000000" size="2">Please print this receipt for your records.</font></p>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"></td>
  </tr>
</table>

<table border="0" width="623" cellspacing="0" cellpadding="4" height="45">
  <tr>
    <td width="180"><p align="right"><font face="Arial" size="2"><strong>Billing
    Address: </strong></font></td>
    <td align="left" width="407">BillingCustomerName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">BillingStreet1</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">BillingStreet2</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">BillingCityName, BillingPostalCode</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">BillingStateorProvince</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">BillingCountryName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp;&nbsp;</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp; </td>
  </tr>
  <tr>
    <td width="180"><p align="right"><strong><font face="Arial" size="2">Shipping
    Address: </font></strong></td>
    <td align="left" width="407">ShippingCustomerName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingStreet1</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingStreet2</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingCityName, ShippingPostalCode</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingStateorProvince</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">ShippingCountryName</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp;&nbsp;</td>
  </tr>
  <tr>
    <td width="180"></td>
    <td align="left" width="407">&nbsp; </td>
  </tr>
</table>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"><font face="Arial" size="2" color="#FFFFFF"><strong>Billing Information</strong></font></td>
  </tr>
</table>

<table border="0" width="623" cellspacing="0" cellpadding="4" height="45">';

#  <tr>
#    <td width="192"><p align="right"><strong><font face="Arial" size="2">Payment
#    Method: </font></strong></td>
#    <td align="left" width="441">PayPal Account</td>
#  </tr>

$output .= '<tr>
    <td width="192"></td>
    <td align="left" width="441">PayPalName</td>
  </tr>
  <tr>
    <td width="192">&nbsp;&nbsp;</td>
    <td align="left" width="441"></td>
  </tr>
  <tr>
    <td width="192"><p align="right"><strong><font face="Arial" size="2">PayPal
    Transaction ID:</font></strong></td>
    <td align="left" width="441">PayPalTransactionID</td>
  </tr>
</table>

<table border="0" width="623" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="617"><font face="Arial" size="2" color="#FFFFFF"><strong>Order Details</strong></font></td>
  </tr>
</table>

<p>&nbsp;</p>


<table border="1" width="600" cellspacing="0" cellpadding="2">
  <tr>
    <td style="background-color: rgb(220,220,220)" width="450"><strong><font face="Arial"
    size="2">Item</font></strong></td>
    <td style="background-color: rgb(220,220,220)" width="50"><font face="Arial" size="2"><strong>Unit Price</strong></font></td>
    <td style="background-color: rgb(220,220,220)" width="50"><strong><font face="Arial"
    size="2">Quantity</font></strong></td>
    <td style="background-color: rgb(220,220,220)" width="50"><strong><font face="Arial"
    size="2">Totals</font></strong></td>
  </tr>
<!--table-->
</table>
</body>
</html>';
	
return $output;	
	
}


sub direct_order_form
{
my $output =
'<html>
<head>
<title>Direct Order Form</title>
<script language="JavaScript">
<!--
function Form_Validator(theForm)
{

if (theForm.cc_number.value == "")
  {
    alert("Please enter a credit card number.");
    theForm.cc_number.focus();
    return (false);
  }

if (theForm.cc_security_code.value == "")
  {
    alert("Please enter a Security Code (CVV).");
    theForm.cc_security_code.focus();
    return (false);
  }

  
if (theForm.cc_first_name.value == "")
  {
    alert("Please enter a value for the \First Name\" field.");
    theForm.cc_first_name.focus();
    return (false);
  }


  if (theForm.cc_last_name.value == "")
  {
    alert("Please enter a value for the \Last Name\" field.");
    theForm.cc_last_name.focus();
    return (false);
  }

 
  if (theForm.cc_addr1.value == "")
  {
    alert("Please enter a value for the \"Address\" field.");
    theForm.cc_addr1.focus();
    return (false);
  }


 if (theForm.cc_city.value == "")
  {
    alert("Please enter a value for the \"Town City\" field.");
    theForm.cc_city.focus();
    return (false);
  }


  if (theForm.cc_postcode.value == "")
  {
    alert("Please enter a value for the \"Postal Code\" field.");
    theForm.cc_postcode.focus();
    return (false);
  }


  if (theForm.cc_email.value == "")
  {
    alert("Please enter a value for the \"E-Mail Address\" field.");
    theForm.cc_email.focus();
    return (false);
  }


  return (true);
}
//--></script>
</head>

<body onload="focus();" bgcolor="#ffffff" text="#000000">

<p>&nbsp;</p>

<table border="0" width="621" cellpadding="2" cellspacing="0" bgcolor="#008080">
  <tr>
    <td width="615"><font face="Arial" size="2" color="#FFFFFF"><strong>Credit Card Details</strong></font></td>
  </tr>
</table>

<form method="post" action="paypal_pro.pl" name="Form1"
onsubmit="return Form_Validator(this)">
  <input type="hidden" name="Action" value="send_all"><input type="hidden" name="e_mail"
  value="e_mail_address"><input type="hidden" name="cgi-form" value="true"><input
  type="hidden" name="pro" value="2"><input type="hidden" name="epdq" value="true"><!--info_goes_here-->
<table
  border="0" height="174" cellspacing="0" cellpadding="0" width="615">
<tbody>
    <tr>
      <td height="23" width="245" align="right"><font face="Arial" size="2">Credit Card
      Type:&nbsp; </font></td>
      <td align="left" height="23" width="332"><select name="cc_type" size="1">
        <option value="Visa">Visa</option>
        <option value="MasterCard">MasterCard</option>
        <option value="Amex">Amex</option>
        <option value="Discover">Discover</option>
      </select></td>
    </tr>
    <tr>
      <td height="23" width="245" align="right"><font face="Arial" size="2">Credit Card
      Number:&nbsp; </font></td>
      <td align="left" height="23" width="332"><input name="cc_number" size="40" type="text"></td>
    </tr>
    <tr>
      <td height="23" width="245" align="right"><font face="Arial" size="2">Security Code
      (CVV):&nbsp; </font></td>
      <td align="left" height="23" width="332"><font face="Arial" size="3"><input
      name="cc_security_code" size="3" MAXLENGTH="3" type="text"></font></td>
    </tr>
    <tr>
      <td height="23" width="245" align="right"><font face="Arial" size="2">Expiration
      Date:&nbsp; </font></td>
      <td align="left" height="23" width="332"><select name="cc_month" size="1">
        <option value="01">01</option>
        <option value="02">02</option>
        <option value="03">03</option>
        <option value="04">04</option>
        <option value="05">05</option>
        <option value="06">06</option>
        <option value="07">07</option>
        <option value="08">08</option>
        <option value="09">09</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
      </select><select name="cc_year" size="1">
        <option value="2008">2008</option>
        <option value="2009">2009</option>
        <option value="2010">2010</option>
        <option value="2011">2011</option>
        <option value="2012">2012</option>
        <option value="2013">2013</option>
        <option value="2014">2014</option>
        <option value="2015">2015</option>
        <option value="2016">2016</option>
        <option value="2017">2017</option>
        <option value="2018">2018</option>
        <option value="2019">2019</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
      </select></td>
    </tr>
    <tr>
      <td colspan="2" height="2" width="615">&nbsp;&nbsp;</td>
    </tr>
    <tr>
      <td colspan="2" height="2" width="615" style="background-color: rgb(0,128,128)"><font
      face="Arial" size="2" color="#FFFFFF"><strong>Billing Address</strong></font></td>
    </tr>
    <tr>
      <td colspan="2" height="2" width="615"></td>
    </tr>
    <tr>
      <td height="23" width="223" align="right"><font face="Arial" size="2">First Name:</font></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="cc_first_name" size="40" type="text"></font></td>
    </tr>
    <tr>
      <td height="23" width="223" align="right"><font face="Arial" size="2">Last Name:</font></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="cc_last_name" size="40" type="text"></font></td>
    </tr>
    <tr>
      <td height="23" width="223" align="right"><font face="Arial" size="2">Address:</font></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="cc_addr1" size="40" type="text"></font></td>
    </tr>
    <tr>
      <td height="23" width="223"></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="cc_addr2" size="40" type="text"></font></td>
    </tr>
    <tr>
      <td height="23" width="223" align="right"><font face="Arial" size="2">Town/City:</font></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input name="cc_city"
      size="40" type="text"></font></td>
    </tr>
    <tr>
      <td height="23" width="223" align="right"><font face="Arial" size="2">US State or Canadian
      Province:</font></td>
      <td align="left" height="23" width="392"><select name="cc_state" size="1">
        <option value>Select a State or Province</option>
        <option value="AB">Alberta</option>
        <option value="AL">Alabama</option>
        <option value="AK">Alaska</option>
        <option value="AZ">Arizona</option>
        <option value="AR">Arkansas</option>
        <option value="BC">British Columbia</option>
        <option value="CA">California</option>
        <option value="CO">Colorado</option>
        <option value="CT">Connecticut</option>
        <option value="DE">Delaware</option>
        <option value="DC">District of Columbia</option>
        <option value="FL">Florida</option>
        <option value="GA">Georgia</option>
        <option value="HI">Hawaii</option>
        <option value="ID">Idaho</option>
        <option value="IL">Illinois</option>
        <option value="IN">Indiana</option>
        <option value="IA">Iowa</option>
        <option value="KS">Kansas</option>
        <option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option>
        <option value="MB">Manitoba</option>
        <option value="ME">Maine</option>
        <option value="MD">Maryland</option>
        <option value="MA">Massachusetts</option>
        <option value="MI">Michigan</option>
        <option value="MN">Minnesota</option>
        <option value="MS">Mississippi</option>
        <option value="MO">Missouri</option>
        <option value="MT">Montana</option>
        <option value="NE">Nebraska</option>
        <option value="NV">Nevada</option>
        <option value="NB">New Brunswick</option>
        <option value="NH">New Hampshire</option>
        <option value="NJ">New Jersey</option>
        <option value="NM">New Mexico</option>
        <option value="NY">New York</option>
        <option value="NC">North Carolina</option>
        <option value="ND">North Dakota</option>
        <option value="NL">Newfoundland</option>
        <option value="NS">Nova Scotia</option>
        <option value="NT">Northwest Territories</option>
        <option value="NU">Nunavut</option>
        <option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option>
        <option value="ON">Ontario</option>
        <option value="OR">Oregon</option>
        <option value="PA">Pennsylvania</option>
        <option value="PE">Prince Edward Island</option>
        <option value="QC">Quebec</option>
        <option value="RI">Rhode Island</option>
        <option value="SK">Saskatchewan</option>
        <option value="SC">South Carolina</option>
        <option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option>
        <option value="TX">Texas</option>
        <option value="UT">Utah</option>
        <option value="VT">Vermont</option>
        <option value="VA">Virginia</option>
        <option value="WA">Washington</option>
        <option value="WV">West Virginia</option>
        <option value="WI">Wisconsin</option>
        <option value="WY">Wyoming</option>
        <option value="YT">Yukon</option>
      </select> </td>
    </tr>
    <tr>
      <td height="23" width="223" align="right"><font face="Arial" size="2">Country:</font></td>
      <td align="left" height="23" width="392"><select name="cc_country" size="1">
        <option>Select a country </option>
        <option value="AF">Afghanistan </option>
        <option value="AL">Albania </option>
        <option value="DZ">Algeria </option>
        <option value="AS">American Samoa </option>
        <option value="AD">Andorra </option>
        <option value="AO">Angola </option>
        <option value="AI">Anguilla </option>
        <option value="AQ">Antarctica </option>
        <option value="AG">Antigua And Barbuda </option>
        <option value="AR">Argentina </option>
        <option value="AM">Armenia </option>
        <option value="AW">Aruba </option>
        <option value="AU">Australia </option>
        <option value="AT">Austria </option>
        <option value="AZ">Azerbaijan </option>
        <option value="BS">Bahamas </option>
        <option value="BH">Bahrain </option>
        <option value="BD">Bangladesh </option>
        <option value="BB">Barbados </option>
        <option value="BY">Belarus </option>
        <option value="BE">Belgium </option>
        <option value="BZ">Belize </option>
        <option value="BJ">Benin </option>
        <option value="BM">Bermuda </option>
        <option value="BT">Bhutan </option>
        <option value="BO">Bolivia </option>
        <option value="BA">Bosnia And Herzegowina </option>
        <option value="BW">Botswana </option>
        <option value="BV">Bouvet Island </option>
        <option value="BR">Brazil </option>
        <option value="IO">British Indian Ocean Territory </option>
        <option value="BN">Brunei Darussalam </option>
        <option value="BG">Bulgaria </option>
        <option value="BF">Burkina Faso </option>
        <option value="BI">Burundi </option>
        <option value="KH">Cambodia </option>
        <option value="CM">Cameroon </option>
        <option value="CA">Canada </option>
        <option value="CV">Cape Verde </option>
        <option value="KY">Cayman Islands </option>
        <option value="CF">Central African Republic </option>
        <option value="TD">Chad </option>
        <option value="CL">Chile </option>
        <option value="CN">China </option>
        <option value="CX">Christmas Island </option>
        <option value="CC">Cocos (Keeling) Islands </option>
        <option value="CO">Colombia </option>
        <option value="KM">Comoros </option>
        <option value="CG">Congo </option>
        <option value="CK">Cook Islands </option>
        <option value="CR">Costa Rica </option>
        <option value="CI">Cote D\'Ivoire </option>
        <option value="HR">Croatia </option>
        <option value="CU">Cuba </option>
        <option value="CY">Cyprus </option>
        <option value="CZ">Czech Republic </option>
        <option value="DK">Denmark </option>
        <option value="DJ">Djibouti </option>
        <option value="DM">Dominica </option>
        <option value="DO">Dominican Republic </option>
        <option value="TP">East Timor </option>
        <option value="EC">Ecuador </option>
        <option value="EG">Egypt </option>
        <option value="SV">El Salvador </option>
        <option value="GQ">Equatorial Guinea </option>
        <option value="ER">Eritrea </option>
        <option value="EE">Estonia </option>
        <option value="ET">Ethiopia </option>
        <option value="FK">Falkland Islands </option>
        <option value="FO">Faroe Islands </option>
        <option value="FJ">Fiji </option>
        <option value="FI">Finland </option>
        <option value="FR">France </option>
        <option value="FX">France, Metropolitan </option>
        <option value="GF">French Guiana </option>
        <option value="PF">French Polynesia </option>
        <option value="TF">French Southern Territories </option>
        <option value="GA">Gabon </option>
        <option value="GM">Gambia </option>
        <option value="GE">Georgia </option>
        <option value="DE">Germany </option>
        <option value="GH">Ghana </option>
        <option value="GI">Gibraltar </option>
        <option value="GR">Greece </option>
        <option value="GL">Greenland </option>
        <option value="GD">Grenada </option>
        <option value="GP">Guadeloupe </option>
        <option value="GU">Guam </option>
        <option value="GT">Guatemala </option>
        <option value="GN">Guinea </option>
        <option value="GW">Guinea-Bissau </option>
        <option value="GY">Guyana </option>
        <option value="HT">Haiti </option>
        <option value="HM">Heard And Mc Donald Islands </option>
        <option value="HN">Honduras </option>
        <option value="HK">Hong Kong </option>
        <option value="HU">Hungary </option>
        <option value="IS">Iceland </option>
        <option value="IN">India </option>
        <option value="ID">Indonesia </option>
        <option value="IR">Iran </option>
        <option value="IQ">Iraq </option>
        <option value="IE">Ireland </option>
        <option value="IL">Israel </option>
        <option value="IT">Italy </option>
        <option value="JM">Jamaica </option>
        <option value="JP">Japan </option>
        <option value="JO">Jordan </option>
        <option value="KZ">Kazakhstan </option>
        <option value="KE">Kenya </option>
        <option value="KI">Kiribati </option>
        <option value="KP">North Korea </option>
        <option value="KR">South Korea </option>
        <option value="KW">Kuwait </option>
        <option value="KG">Kyrgyzstan </option>
        <option value="LA">Lao People\'s Republic </option>
        <option value="LV">Latvia </option>
        <option value="LB">Lebanon </option>
        <option value="LS">Lesotho </option>
        <option value="LR">Liberia </option>
        <option value="LY">Libyan Arab Jamahiriya </option>
        <option value="LI">Liechtenstein </option>
        <option value="LT">Lithuania </option>
        <option value="LU">Luxembourg </option>
        <option value="MO">Macau </option>
        <option value="MK">Macedonia </option>
        <option value="MG">Madagascar </option>
        <option value="MW">Malawi </option>
        <option value="MY">Malaysia </option>
        <option value="MV">Maldives </option>
        <option value="ML">Mali </option>
        <option value="MT">Malta </option>
        <option value="MH">Marshall Islands </option>
        <option value="MQ">Martinique </option>
        <option value="MR">Mauritania </option>
        <option value="MU">Mauritius </option>
        <option value="YT">Mayotte </option>
        <option value="MX">Mexico </option>
        <option value="FM">Micronesia </option>
        <option value="MD">Moldova </option>
        <option value="MC">Monaco </option>
        <option value="MN">Mongolia </option>
        <option value="MS">Montserrat </option>
        <option value="MA">Morocco </option>
        <option value="MZ">Mozambique </option>
        <option value="MM">Myanmar </option>
        <option value="NA">Namibia </option>
        <option value="NR">Nauru </option>
        <option value="NP">Nepal </option>
        <option value="NL">Netherlands </option>
        <option value="AN">Netherlands Antilles </option>
        <option value="NC">New Caledonia </option>
        <option value="NZ">New Zealand </option>
        <option value="NI">Nicaragua </option>
        <option value="NE">Niger </option>
        <option value="NG">Nigeria </option>
        <option value="NU">Niue </option>
        <option value="NF">Norfolk Island </option>
        <option value="MP">Northern Mariana Islands </option>
        <option value="NO">Norway </option>
        <option value="OM">Oman </option>
        <option value="PK">Pakistan </option>
        <option value="PW">Palau </option>
        <option value="PA">Panama </option>
        <option value="PG">Papua New Guinea </option>
        <option value="PY">Paraguay </option>
        <option value="PE">Peru </option>
        <option value="PH">Philippines </option>
        <option value="PN">Pitcairn </option>
        <option value="PL">Poland </option>
        <option value="PT">Portugal </option>
        <option value="PR">Puerto Rico </option>
        <option value="QA">Qatar </option>
        <option value="RE">Reunion </option>
        <option value="RO">Romania </option>
        <option value="RU">Russian Federation </option>
        <option value="RW">Rwanda </option>
        <option value="KN">Saint Kitts And Nevis </option>
        <option value="LC">Saint Lucia </option>
        <option value="VC">Saint Vincent And The Grenadines </option>
        <option value="WS">Samoa </option>
        <option value="SM">San Marino </option>
        <option value="ST">Sao Tome And Principe </option>
        <option value="SA">Saudi Arabia </option>
        <option value="SN">Senegal </option>
        <option value="SC">Seychelles </option>
        <option value="SL">Sierra Leone </option>
        <option value="SG">Singapore </option>
        <option value="SK">Slovakia </option>
        <option value="SI">Slovenia </option>
        <option value="SB">Solomon Islands </option>
        <option value="SO">Somalia </option>
        <option value="ZA">South Africa </option>
        <option value="GS">South Georgia And The South Sandwich Islands </option>
        <option value="ES">Spain </option>
        <option value="LK">Sri Lanka </option>
        <option value="SH">St Helena </option>
        <option value="PM">St Pierre and Miquelon </option>
        <option value="SD">Sudan </option>
        <option value="SR">Suriname </option>
        <option value="SJ">Svalbard And Jan Mayen Islands </option>
        <option value="SZ">Swaziland </option>
        <option value="SE">Sweden </option>
        <option value="CH">Switzerland </option>
        <option value="SY">Syrian Arab Republic </option>
        <option value="TW">Taiwan </option>
        <option value="TJ">Tajikistan </option>
        <option value="TZ">Tanzania </option>
        <option value="TH">Thailand </option>
        <option value="TG">Togo </option>
        <option value="TK">Tokelau </option>
        <option value="TO">Tonga </option>
        <option value="TT">Trinidad And Tobago </option>
        <option value="TN">Tunisia </option>
        <option value="TR">Turkey </option>
        <option value="TM">Turkmenistan </option>
        <option value="TC">Turks And Caicos Islands </option>
        <option value="TV">Tuvalu </option>
        <option value="UG">Uganda </option>
        <option value="UA">Ukraine </option>
        <option value="AE">United Arab Emirates </option>
        <option value="GB">United Kingdom</option>
        <option selected="selected" value="US">United States </option>
        <option value="UM">United States Minor Outlying Islands </option>
        <option value="UY">Uruguay </option>
        <option value="UZ">Uzbekistan </option>
        <option value="VU">Vanuatu </option>
        <option value="VA">Vatican City State </option>
        <option value="VE">Venezuela </option>
        <option value="VN">Viet Nam </option>
        <option value="VG">Virgin Islands (British) </option>
        <option value="VI">Virgin Islands (U.S.) </option>
        <option value="WF">Wallis And Futuna Islands </option>
        <option value="EH">Western Sahara </option>
        <option value="YE">Yemen </option>
        <option value="ZR">Zaire </option>
        <option value="ZM">Zambia </option>
        <option value="ZW">Zimbabwe </option>
        <option value="ZZ">Other-Not Shown </option>
      </select></td>
    </tr>
    <tr>
      <td height="1" width="223" align="right"><font face="Arial" size="2">Post/Zip/Area Code:</font></td>
      <td align="left" height="1" width="392"><font face="Arial" size="3"><input
      name="cc_postcode" size="20" type="text"></font></td>
    </tr>
    <tr>
      <td height="1" width="223" align="right"><font face="Arial" size="2">E-Mail:</font></td>
      <td align="left" height="1" width="392"><font face="Arial" size="3"><input name="cc_email"
      size="20" type="text"></font></td>
    </tr>
    <tr>
      <td height="1" width="223" align="right"><font face="Arial" size="2">Telephone Number: </font></td>
      <td align="left" height="1" width="392"><font face="Arial" size="3"><input
      name="cc_telephone" size="20" type="text"></font></td>
    </tr>
    <tr>
      <td height="1" width="223">&nbsp;&nbsp;</td>
      <td align="left" height="1" width="392"></td>
    </tr>
    <tr>
      <td height="0" width="223" align="right"><strong><font face="Arial" size="2">Delivery
      Address: </font></strong></td>
      <td align="left" height="0" width="392"><font face="Arial" size="2">Tick box </font><input
      type="checkbox" name="delivery_address" value="ON"
      onclick="del_name.value=cc_first_name.value+\' \'+cc_last_name.value;
del_addr1.value=cc_addr1.value;
del_addr2.value=cc_addr2.value;
del_city.value=cc_city.value;
del_state.value=cc_state.value;
del_postalcode.value=cc_postcode.value;
del_country.value=cc_country.value;
"><font
      face="Arial" size="2"> if Delvery Address is the same as Billing Address </font></td>
    </tr>
    <tr>
      <td height="1" width="223">&nbsp;&nbsp;</td>
      <td align="left" height="1" width="392"></td>
    </tr>
    <tr align="center">
      <td height="23" width="223" align="right"><font face="Arial" size="2">Name:</font></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="del_name" size="40" type="text"></font></td>
    </tr>
    <tr align="center">
      <td height="23" width="223" align="right"><font face="Arial" size="2">Address:</font></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="del_addr1" size="40" type="text"></font></td>
    </tr>
    <tr align="center">
      <td height="23" width="223" align="right"></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="del_addr2" size="40" type="text"></font></td>
    </tr>
    <tr align="center">
      <td height="23" width="223" align="right"><font face="Arial" size="2">Town/City:</font></td>
      <td align="left" height="23" width="392"><font face="Arial" size="3"><input
      name="del_city" size="40" type="text"></font></td>
    </tr>
    <tr align="center">
      <td height="23" width="223" align="right"><font face="Arial" size="2">US State or Canadian
      Province:</font></td>
      <td align="left" height="23" width="392"><select name="del_state" size="1">
        <option value>Select a State or Province</option>
        <option value="AB">Alberta</option>
        <option value="AL">Alabama</option>
        <option value="AK">Alaska</option>
        <option value="AZ">Arizona</option>
        <option value="AR">Arkansas</option>
        <option value="BC">British Columbia</option>
        <option value="CA">California</option>
        <option value="CO">Colorado</option>
        <option value="CT">Connecticut</option>
        <option value="DE">Delaware</option>
        <option value="DC">District of Columbia</option>
        <option value="FL">Florida</option>
        <option value="GA">Georgia</option>
        <option value="HI">Hawaii</option>
        <option value="ID">Idaho</option>
        <option value="IL">Illinois</option>
        <option value="IN">Indiana</option>
        <option value="IA">Iowa</option>
        <option value="KS">Kansas</option>
        <option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option>
        <option value="MB">Manitoba</option>
        <option value="ME">Maine</option>
        <option value="MD">Maryland</option>
        <option value="MA">Massachusetts</option>
        <option value="MI">Michigan</option>
        <option value="MN">Minnesota</option>
        <option value="MS">Mississippi</option>
        <option value="MO">Missouri</option>
        <option value="MT">Montana</option>
        <option value="NE">Nebraska</option>
        <option value="NV">Nevada</option>
        <option value="NB">New Brunswick</option>
        <option value="NH">New Hampshire</option>
        <option value="NJ">New Jersey</option>
        <option value="NM">New Mexico</option>
        <option value="NY">New York</option>
        <option value="NC">North Carolina</option>
        <option value="ND">North Dakota</option>
        <option value="NL">Newfoundland</option>
        <option value="NS">Nova Scotia</option>
        <option value="NT">Northwest Territories</option>
        <option value="NU">Nunavut</option>
        <option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option>
        <option value="ON">Ontario</option>
        <option value="OR">Oregon</option>
        <option value="PA">Pennsylvania</option>
        <option value="PE">Prince Edward Island</option>
        <option value="QC">Quebec</option>
        <option value="RI">Rhode Island</option>
        <option value="SK">Saskatchewan</option>
        <option value="SC">South Carolina</option>
        <option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option>
        <option value="TX">Texas</option>
        <option value="UT">Utah</option>
        <option value="VT">Vermont</option>
        <option value="VA">Virginia</option>
        <option value="WA">Washington</option>
        <option value="WV">West Virginia</option>
        <option value="WI">Wisconsin</option>
        <option value="WY">Wyoming</option>
        <option value="YT">Yukon</option>
      </select> </td>
    </tr>
    <tr align="center">
      <td height="23" width="223" align="right"><font face="Arial" size="2">Country:</font></td>
      <td align="left" height="23" width="392"><select name="del_country" size="1">
        <option>Select a country </option>
        <option value="AF">Afghanistan </option>
        <option value="AL">Albania </option>
        <option value="DZ">Algeria </option>
        <option value="AS">American Samoa </option>
        <option value="AD">Andorra </option>
        <option value="AO">Angola </option>
        <option value="AI">Anguilla </option>
        <option value="AQ">Antarctica </option>
        <option value="AG">Antigua And Barbuda </option>
        <option value="AR">Argentina </option>
        <option value="AM">Armenia </option>
        <option value="AW">Aruba </option>
        <option value="AU">Australia </option>
        <option value="AT">Austria </option>
        <option value="AZ">Azerbaijan </option>
        <option value="BS">Bahamas </option>
        <option value="BH">Bahrain </option>
        <option value="BD">Bangladesh </option>
        <option value="BB">Barbados </option>
        <option value="BY">Belarus </option>
        <option value="BE">Belgium </option>
        <option value="BZ">Belize </option>
        <option value="BJ">Benin </option>
        <option value="BM">Bermuda </option>
        <option value="BT">Bhutan </option>
        <option value="BO">Bolivia </option>
        <option value="BA">Bosnia And Herzegowina </option>
        <option value="BW">Botswana </option>
        <option value="BV">Bouvet Island </option>
        <option value="BR">Brazil </option>
        <option value="IO">British Indian Ocean Territory </option>
        <option value="BN">Brunei Darussalam </option>
        <option value="BG">Bulgaria </option>
        <option value="BF">Burkina Faso </option>
        <option value="BI">Burundi </option>
        <option value="KH">Cambodia </option>
        <option value="CM">Cameroon </option>
        <option value="CA">Canada </option>
        <option value="CV">Cape Verde </option>
        <option value="KY">Cayman Islands </option>
        <option value="CF">Central African Republic </option>
        <option value="TD">Chad </option>
        <option value="CL">Chile </option>
        <option value="CN">China </option>
        <option value="CX">Christmas Island </option>
        <option value="CC">Cocos (Keeling) Islands </option>
        <option value="CO">Colombia </option>
        <option value="KM">Comoros </option>
        <option value="CG">Congo </option>
        <option value="CK">Cook Islands </option>
        <option value="CR">Costa Rica </option>
        <option value="CI">Cote D\'Ivoire </option>
        <option value="HR">Croatia </option>
        <option value="CU">Cuba </option>
        <option value="CY">Cyprus </option>
        <option value="CZ">Czech Republic </option>
        <option value="DK">Denmark </option>
        <option value="DJ">Djibouti </option>
        <option value="DM">Dominica </option>
        <option value="DO">Dominican Republic </option>
        <option value="TP">East Timor </option>
        <option value="EC">Ecuador </option>
        <option value="EG">Egypt </option>
        <option value="SV">El Salvador </option>
        <option value="GQ">Equatorial Guinea </option>
        <option value="ER">Eritrea </option>
        <option value="EE">Estonia </option>
        <option value="ET">Ethiopia </option>
        <option value="FK">Falkland Islands </option>
        <option value="FO">Faroe Islands </option>
        <option value="FJ">Fiji </option>
        <option value="FI">Finland </option>
        <option value="FR">France </option>
        <option value="FX">France, Metropolitan </option>
        <option value="GF">French Guiana </option>
        <option value="PF">French Polynesia </option>
        <option value="TF">French Southern Territories </option>
        <option value="GA">Gabon </option>
        <option value="GM">Gambia </option>
        <option value="GE">Georgia </option>
        <option value="DE">Germany </option>
        <option value="GH">Ghana </option>
        <option value="GI">Gibraltar </option>
        <option value="GR">Greece </option>
        <option value="GL">Greenland </option>
        <option value="GD">Grenada </option>
        <option value="GP">Guadeloupe </option>
        <option value="GU">Guam </option>
        <option value="GT">Guatemala </option>
        <option value="GN">Guinea </option>
        <option value="GW">Guinea-Bissau </option>
        <option value="GY">Guyana </option>
        <option value="HT">Haiti </option>
        <option value="HM">Heard And Mc Donald Islands </option>
        <option value="HN">Honduras </option>
        <option value="HK">Hong Kong </option>
        <option value="HU">Hungary </option>
        <option value="IS">Iceland </option>
        <option value="IN">India </option>
        <option value="ID">Indonesia </option>
        <option value="IR">Iran </option>
        <option value="IQ">Iraq </option>
        <option value="IE">Ireland </option>
        <option value="IL">Israel </option>
        <option value="IT">Italy </option>
        <option value="JM">Jamaica </option>
        <option value="JP">Japan </option>
        <option value="JO">Jordan </option>
        <option value="KZ">Kazakhstan </option>
        <option value="KE">Kenya </option>
        <option value="KI">Kiribati </option>
        <option value="KP">North Korea </option>
        <option value="KR">South Korea </option>
        <option value="KW">Kuwait </option>
        <option value="KG">Kyrgyzstan </option>
        <option value="LA">Lao People\'s Republic </option>
        <option value="LV">Latvia </option>
        <option value="LB">Lebanon </option>
        <option value="LS">Lesotho </option>
        <option value="LR">Liberia </option>
        <option value="LY">Libyan Arab Jamahiriya </option>
        <option value="LI">Liechtenstein </option>
        <option value="LT">Lithuania </option>
        <option value="LU">Luxembourg </option>
        <option value="MO">Macau </option>
        <option value="MK">Macedonia </option>
        <option value="MG">Madagascar </option>
        <option value="MW">Malawi </option>
        <option value="MY">Malaysia </option>
        <option value="MV">Maldives </option>
        <option value="ML">Mali </option>
        <option value="MT">Malta </option>
        <option value="MH">Marshall Islands </option>
        <option value="MQ">Martinique </option>
        <option value="MR">Mauritania </option>
        <option value="MU">Mauritius </option>
        <option value="YT">Mayotte </option>
        <option value="MX">Mexico </option>
        <option value="FM">Micronesia </option>
        <option value="MD">Moldova </option>
        <option value="MC">Monaco </option>
        <option value="MN">Mongolia </option>
        <option value="MS">Montserrat </option>
        <option value="MA">Morocco </option>
        <option value="MZ">Mozambique </option>
        <option value="MM">Myanmar </option>
        <option value="NA">Namibia </option>
        <option value="NR">Nauru </option>
        <option value="NP">Nepal </option>
        <option value="NL">Netherlands </option>
        <option value="AN">Netherlands Antilles </option>
        <option value="NC">New Caledonia </option>
        <option value="NZ">New Zealand </option>
        <option value="NI">Nicaragua </option>
        <option value="NE">Niger </option>
        <option value="NG">Nigeria </option>
        <option value="NU">Niue </option>
        <option value="NF">Norfolk Island </option>
        <option value="MP">Northern Mariana Islands </option>
        <option value="NO">Norway </option>
        <option value="OM">Oman </option>
        <option value="PK">Pakistan </option>
        <option value="PW">Palau </option>
        <option value="PA">Panama </option>
        <option value="PG">Papua New Guinea </option>
        <option value="PY">Paraguay </option>
        <option value="PE">Peru </option>
        <option value="PH">Philippines </option>
        <option value="PN">Pitcairn </option>
        <option value="PL">Poland </option>
        <option value="PT">Portugal </option>
        <option value="PR">Puerto Rico </option>
        <option value="QA">Qatar </option>
        <option value="RE">Reunion </option>
        <option value="RO">Romania </option>
        <option value="RU">Russian Federation </option>
        <option value="RW">Rwanda </option>
        <option value="KN">Saint Kitts And Nevis </option>
        <option value="LC">Saint Lucia </option>
        <option value="VC">Saint Vincent And The Grenadines </option>
        <option value="WS">Samoa </option>
        <option value="SM">San Marino </option>
        <option value="ST">Sao Tome And Principe </option>
        <option value="SA">Saudi Arabia </option>
        <option value="SN">Senegal </option>
        <option value="SC">Seychelles </option>
        <option value="SL">Sierra Leone </option>
        <option value="SG">Singapore </option>
        <option value="SK">Slovakia </option>
        <option value="SI">Slovenia </option>
        <option value="SB">Solomon Islands </option>
        <option value="SO">Somalia </option>
        <option value="ZA">South Africa </option>
        <option value="GS">South Georgia And The South Sandwich Islands </option>
        <option value="ES">Spain </option>
        <option value="LK">Sri Lanka </option>
        <option value="SH">St Helena </option>
        <option value="PM">St Pierre and Miquelon </option>
        <option value="SD">Sudan </option>
        <option value="SR">Suriname </option>
        <option value="SJ">Svalbard And Jan Mayen Islands </option>
        <option value="SZ">Swaziland </option>
        <option value="SE">Sweden </option>
        <option value="CH">Switzerland </option>
        <option value="SY">Syrian Arab Republic </option>
        <option value="TW">Taiwan </option>
        <option value="TJ">Tajikistan </option>
        <option value="TZ">Tanzania </option>
        <option value="TH">Thailand </option>
        <option value="TG">Togo </option>
        <option value="TK">Tokelau </option>
        <option value="TO">Tonga </option>
        <option value="TT">Trinidad And Tobago </option>
        <option value="TN">Tunisia </option>
        <option value="TR">Turkey </option>
        <option value="TM">Turkmenistan </option>
        <option value="TC">Turks And Caicos Islands </option>
        <option value="TV">Tuvalu </option>
        <option value="UG">Uganda </option>
        <option value="UA">Ukraine </option>
        <option value="AE">United Arab Emirates </option>
        <option value="GB">United Kingdom</option>
        <option selected="selected" value="US">United States </option>
        <option value="UM">United States Minor Outlying Islands </option>
        <option value="UY">Uruguay </option>
        <option value="UZ">Uzbekistan </option>
        <option value="VU">Vanuatu </option>
        <option value="VA">Vatican City State </option>
        <option value="VE">Venezuela </option>
        <option value="VN">Viet Nam </option>
        <option value="VG">Virgin Islands (British) </option>
        <option value="VI">Virgin Islands (U.S.) </option>
        <option value="WF">Wallis And Futuna Islands </option>
        <option value="EH">Western Sahara </option>
        <option value="YE">Yemen </option>
        <option value="ZR">Zaire </option>
        <option value="ZM">Zambia </option>
        <option value="ZW">Zimbabwe </option>
        <option value="ZZ">Other-Not Shown </option>
      </select></td>
    </tr>
    <tr align="center">
      <td height="1" width="223" align="right"><font face="Arial" size="2">Post/Zip/Area Code:</font></td>
      <td align="left" height="1" width="392"><font face="Arial" size="3"><input
      name="del_postalcode" size="20" type="text"></font></td>
    </tr>
    <tr align="center">
      <td height="1" width="223">&nbsp;&nbsp;</td>
      <td align="left" height="1" width="392"></td>
    </tr>
    <tr align="center">
      <td height="1" width="615" colspan="2" style="background-color: rgb(0,128,128)"
      align="left">&nbsp;&nbsp;</td>
    </tr>
    <tr align="center">
      <td height="1" width="223">&nbsp;&nbsp;</td>
      <td align="left" height="1" width="392"></td>
    </tr>
    <tr align="center">
      <td height="1" width="223">&nbsp;&nbsp;</td>
      <td align="left" height="1" width="392"><font face="Arial" size="3"><input
      value="Place Order" name="B1" type="submit"> <input value="Reset" name="B2" type="reset"></font>&nbsp;
      </td>
    </tr>
</tbody>
  </table>
<!--paypal_pro_2-->
</form>

<p align="center">&nbsp;</p>

<p align="center">&nbsp;</p>
<!--show_info-->

<p align="center">&nbsp;</p>
</body>
</html>';	
	
return $output;	
	
}


sub re_direct
   {
   my ($url) = @_;
   
   #print "HTTP/1.0 302 Moved Temporarily\n";
   #print "Server: $ENV{'SERVER_SOFTWARE'}\n";
   #print "Location: $url\n";
   
  
 	
   print "<HTML><HEAD><TITLE>Shopping Cart</TITLE></HEAD>";	

   
   print'<BODY onLoad = "javascript:this.focus();document.postform.submit();">';
   
   print'<BODY>
   <p align="center"><font color="#0000FF"><strong><big><big><big>
   Connecting to the Server: Please wait
   </big></big></big></strong></font><br><br>
   ';

   print "<FORM name='postform' action='" . $url . "' method ='post'>";                                         

   print "<input type=\"hidden\" name=\"x_show_Form\" value=\"PAYMENT_FORM\">\n";


   print  '<INPUT type="submit" name="submit_button" value="Click if not automatically connected"><br><br>';
   print '</p></FORM>';
   print "<!--version 3.95p 23 April 2008--></BODY></HTML>";
   
   exit;
   }   
   
sub save_temp_file
   {
   my ($file_id,$file_contents)=@_;
   my $data_file = ">" . $temp_dir . "$file_id";
   open(FILE,$data_file) || (&end_cgi( "Could not write to $data_file"));
   print FILE $file_contents . "\n";
   close(FILE);
   }

sub clean_up
   {
   my ($dir)=$temp_dir;
   
   if($dir ne "")
      {
      opendir(DOC,$dir) || (&end_cgi( "could not open $dir"));
      while (my $file=readdir(DOC))
         {
         if ($file =~ /\.tmp/i)
            {
            my ($name)=split(/\./,$file);
            $file=$dir.$file;
            if((-M $file) > 0.01)
               {
               $file =~ s#\.\.([/\:]$)##g;
               unlink($file) || (&end_cgi( "Cannot remove temporary file\n"));
               }
            }
         }
      closedir(DOC);
      }
   }
   
   # Subroutine to handle basic decoding of URL data.
sub url_decode {
    my ($s) = @_;

    # Translate + to space, and %XX to the character code.

    $s =~ tr/+/ /;
    $s =~ s/%([0-9A-F][0-9A-F])/pack("C",oct("0x$1"))/gie;
    $s;
}

sub convert2
   {
   my ($html_info)= @_;
#   $html_info =~ s/&/&amp;/g;      
   $html_info =~ s/"/&quot;/g;

   $html_info =~ s/</&lt;/g;
   $html_info =~ s/>/&gt;/g; 
   $html_info =~ s/'/&#39;/g;	
   #$html_info =~ s//&#8364;/g; 
   $html_info =~ s//&pound;/g;
   return($html_info);
   }


sub convert
   {
   my ($html_info)= @_;
#   $html_info =~ s/&/&amp;/g;      
#   $html_info =~ s/"/&quot;/g;

#   $html_info =~ s/</&lt;/g;
#   $html_info =~ s/>/&gt;/g; 	
   #$html_info =~ s//&#8364;/g; 
   
   return($html_info);
   }
   
sub unconvert
   {
   my ($html_info)= @_;
#   $html_info =~ s/&amp;/&/g;      
#   $html_info =~ s/&quot;/"/g;

#   $html_info =~ s/&lt;/</g;
#   $html_info =~ s/&gt;/>/g;
   #$html_info =~ s/&#8364;//g;  	
   return($html_info);
   }
   
sub uriescape {
	my $text = $_[0];
	return undef unless defined $text;

	# Build a char to hex map
	my %escapes = ();
	for (0..255) {
		$escapes{chr($_)} = sprintf("%%%02X", $_);
	}

	# Default unsafe characters.  RFC 2732 ^(uric - reserved)
	$text =~ s/([\%])/$escapes{$1}/g;
   # $text =~ s/([\"\+\;\,\=\&\:])/$escapes{$1}/g;
    $text =~ s/([\'\0\\?\"\+\;\,\=\&\:\_\r\n])/$escapes{$1}/g;
	$text =~ s/ /\+/g;


	$text;
}

sub uriunescape
   {
   my ($s) = @_;
   $s =~ s/\+/ /g;
   $s =~ s/%([0-9A-Fa-f]{2})/chr(hex($1))/eg; 
	
   return($s);
   }
#}

